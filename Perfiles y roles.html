<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ERP - Perfiles y Roles con Historial</title>

<style>
  body { margin:0; font-family:'Segoe UI', sans-serif; background:#f4f6f9; }
  header { background:#0066cc; color:white; padding:15px 30px; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:22px; }
  header a { color:white; text-decoration:none; }

  .container { padding:30px; }
  h2 { color:#0066cc; }

  table {
    width:100%; border-collapse:collapse; margin-top:20px;
    background:white; border-radius:8px; overflow:hidden;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
  }
  th, td { padding:12px; text-align:left; border-bottom:1px solid #ddd; }
  th { background:#0066cc; color:white; }
  tr:hover { background:#f1f1f1; }

  .btn { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-size:14px; transition:0.3s; }
  .btn-add { background:#28a745; color:white; margin-bottom:15px; }
  .btn-edit { background:#ffc107; color:black; }
  .btn-del { background:#dc3545; color:white; }
  .btn:hover { opacity:0.8; }

  .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
  .modal-content { background:white; padding:20px; border-radius:10px; width:90%; max-width:500px; animation:fadeIn 0.3s ease; }
  .modal-content h3 { margin-top:0; color:#0066cc; }
  .modal-content input, .modal-content select, .modal-content textarea { width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:6px; }
  .close { float:right; font-size:20px; cursor:pointer; color:red; }
  @keyframes fadeIn { from{opacity:0; transform:scale(0.8);} to{opacity:1; transform:scale(1);} }

  .estado-activo { color:green; font-weight:bold; }
  .estado-inactivo { color:orange; font-weight:bold; }
  .estado-eliminado { color:red; font-weight:bold; }
  .historial { margin-top:20px; }
  .historial table { margin-top:10px; }
</style>
</head>
<body>

<header>
  <h1><i class="fas fa-user-shield"></i> Perfiles y Roles</h1>
  <a href="index.html"><i class="fas fa-home"></i> Volver al Dashboard</a>
</header>

<div class="container">
  <h2>Perfiles y Roles</h2>
  <button class="btn btn-add" onclick="openModal()">+ Nuevo Usuario</button>

  <table id="tablaUsuarios">
    <thead>
      <tr>
        <th>ID</th><th>Nombre del Usuario</th><th>Rol Actual</th><th>Descripción</th><th>Estado</th><th>Roles Previos</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="historial">
    <h2>Historial de Cambios</h2>
    <table id="tablaHistorial">
      <thead>
        <tr>
          <th>Fecha/Hora</th><th>Usuario que Modifica</th><th>Usuario Afectado</th><th>Estado Anterior</th><th>Estado Nuevo</th><th>Acción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3 id="modalTitle">Agregar Usuario</h3>
    <input type="hidden" id="editIndex">
    <input type="text" id="nombreUsuario" placeholder="Nombre del Usuario">
    <input type="text" id="rolActual" placeholder="Rol Actual">
    <textarea id="descUsuario" placeholder="Descripción"></textarea>
    <select id="estadoUsuario">
      <option value="Activo">Activo</option>
      <option value="Inactivo">Inactivo</option>
      <option value="Eliminado">Eliminado</option>
    </select>
    <button class="btn btn-add" onclick="guardarUsuario()">Guardar</button>
  </div>
</div>

<script>

const usuarioActual = "Admin";

let usuarios = [
  {id:1, nombre:"Xiomara Pineda", rol:"Administrador", descripcion:"Control total del ERP", estado:"Activo", rolesPrevios:[]},
  {id:2, nombre:"Ana Gómez", rol:"Empleado", descripcion:"Acceso limitado", estado:"Activo", rolesPrevios:[]}
];

let historial = [];
let editando = false;

function renderTabla(){
  const tbody = document.querySelector("#tablaUsuarios tbody");
  tbody.innerHTML = "";
  usuarios.forEach((u,index)=>{
    let claseEstado = u.estado==="Activo"?"estado-activo": u.estado==="Inactivo"?"estado-inactivo":"estado-eliminado";
    tbody.innerHTML += `
      <tr>
        <td>${u.id}</td>
        <td>${u.nombre}</td>
        <td>${u.rol}</td>
        <td>${u.descripcion}</td>
        <td class="${claseEstado}">${u.estado}</td>
        <td>${u.rolesPrevios.join(", ") || "-"}</td>
        <td>
          <button class="btn btn-edit" onclick="editarUsuario(${index})">Editar</button>
          <button class="btn btn-del" onclick="eliminarUsuario(${index})">Eliminar</button>
        </td>
      </tr>
    `;
  });
  renderHistorial();
}

function renderHistorial(){
  const tbody = document.querySelector("#tablaHistorial tbody");
  tbody.innerHTML = "";
  historial.forEach(h=>{
    tbody.innerHTML += `
      <tr>
        <td>${h.fecha}</td>
        <td>${h.usuario}</td>
        <td>${h.usuarioAfectado}</td>
        <td>${h.estadoAnterior}</td>
        <td>${h.estadoNuevo}</td>
        <td>${h.accion}</td>
      </tr>
    `;
  });
}

function openModal(){
  document.getElementById("modal").style.display="flex";
  document.getElementById("modalTitle").innerText="Agregar Usuario";
  document.getElementById("editIndex").value="";
  document.getElementById("nombreUsuario").value="";
  document.getElementById("rolActual").value="";
  document.getElementById("descUsuario").value="";
  document.getElementById("estadoUsuario").value="Activo";
  editando=false;
}

function closeModal(){ document.getElementById("modal").style.display="none"; }

function guardarUsuario(){
  const nombre = document.getElementById("nombreUsuario").value.trim();
  const rol = document.getElementById("rolActual").value.trim();
  const desc = document.getElementById("descUsuario").value.trim();
  const estado = document.getElementById("estadoUsuario").value;
  if(nombre===""){ alert("El nombre del usuario es obligatorio"); return; }
  const fecha = new Date().toLocaleString();

  if(editando){
    const i = document.getElementById("editIndex").value;
    const u = usuarios[i];
    u.rolesPrevios.push(u.rol + " (" + u.estado + ")");
    const estadoAnterior = u.estado;
    u.nombre = nombre;
    u.rol = rol;
    u.descripcion = desc;
    u.estado = estado;
    historial.push({
      fecha, usuario:usuarioActual, usuarioAfectado:nombre,
      estadoAnterior, estadoNuevo:estado, accion:"Edición"
    });
  } else {
    const id = usuarios.length ? usuarios[usuarios.length-1].id+1 : 1;
    usuarios.push({id,nombre,rol,descripcion:desc,estado, rolesPrevios:[]});
    historial.push({
      fecha, usuario:usuarioActual, usuarioAfectado:nombre,
      estadoAnterior:"-", estadoNuevo:estado, accion:"Creación"
    });
  }
  renderTabla();
  closeModal();
}

function editarUsuario(index){
  editando = true;
  const u = usuarios[index];
  document.getElementById("modal").style.display="flex";
  document.getElementById("modalTitle").innerText="Editar Usuario";
  document.getElementById("editIndex").value=index;
  document.getElementById("nombreUsuario").value=u.nombre;
  document.getElementById("rolActual").value=u.rol;
  document.getElementById("descUsuario").value=u.descripcion;
  document.getElementById("estadoUsuario").value=u.estado;
}

function eliminarUsuario(index){
  if(confirm("¿Seguro que quieres marcar este usuario como eliminado?")){
    const fecha = new Date().toLocaleString();
    const u = usuarios[index];
    u.rolesPrevios.push(u.rol + " (" + u.estado + ")");
    const estadoAnterior = u.estado;
    u.estado = "Eliminado";
    historial.push({
      fecha, usuario:usuarioActual, usuarioAfectado:u.nombre,
      estadoAnterior, estadoNuevo:"Eliminado", accion:"Eliminación"
    });
    renderTabla();
  }
}

window.onclick = function(e){
  const modal = document.getElementById("modal");
  if(e.target==modal){ closeModal(); }
};

renderTabla();
</script>

</body>
</html>
