<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Módulo de Facturación - Sistema ERP</title>
  <!-- Iconos y CSS del módulo de Compras -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
   <link rel="stylesheet" th:href="@{/css/ComprasStyle.css}">
</head>
<body>
  <div class="main-container">
    <!-- Sidebar (idéntica a Compras) -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-chart-line"></i> ERP System</h2>
        <p>Sistema Integral de Gestión</p>
      </div>

      <ul class="nav-menu">
        <li class="nav-section"><div class="nav-section-title">PRINCIPAL</div></li>
        <li class="nav-item">
          <a href="/dashboard" class="nav-link"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">ADMINISTRACIÓN</div></li>
        <li class="nav-item">
          <a href="/usuarios" class="nav-link"><i class="fas fa-user-shield"></i><span>Usuarios</span></a>
        </li>
        <li class="nav-item">
          <a href="/contabilidad" class="nav-link"><i class="fas fa-calculator"></i><span>Contabilidad</span></a>
        </li>
<li class="nav-item">
  <a href="/impuesto" class="nav-link">
    <i class="fas fa-percent"></i><span>Impuestos</span>
  </a>
</li>

        <li class="nav-section"><div class="nav-section-title">VENTAS</div></li>
        <li class="nav-item">
          <a href="/clientes" class="nav-link"><i class="fas fa-users"></i><span>Clientes</span></a>
        </li>
        <li class="nav-item">
          <a href="/ventas" class="nav-link"><i class="fas fa-shopping-cart"></i><span>Ventas</span></a>
        </li>
        <li class="nav-item">
          <a href="/facturacion" class="nav-link active"><i class="fas fa-file-invoice"></i><span>Facturación</span></a>
        </li>
        <li class="nav-item">
          <a href="/punto-venta" class="nav-link"><i class="fas fa-cash-register"></i><span>Punto de Venta</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">COMPRAS</div></li>
        <li class="nav-item">
          <a href="/proveedores" class="nav-link"><i class="fas fa-truck"></i><span>Proveedores</span></a>
        </li>
        <li class="nav-item">
          <a href="/compras" class="nav-link"><i class="fas fa-shopping-bag"></i><span>Compras</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">INVENTARIO</div></li>
        <li class="nav-item">
          <a href="/inventario" class="nav-link"><i class="fas fa-boxes"></i><span>Inventario</span></a>
        </li>
        <li class="nav-item">
          <a href="/almacenes" class="nav-link"><i class="fas fa-warehouse"></i><span>Almacenes</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">RECURSOS HUMANOS</div></li>
        <li class="nav-item">
          <a href="/rrhh" class="nav-link"><i class="fas fa-user-tie"></i><span>Empleados</span></a>
        </li>
        <li class="nav-item">
          <a href="/nomina" class="nav-link"><i class="fas fa-money-bill-wave"></i><span>Nómina</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">LOGÍSTICA</div></li>
        <li class="nav-item">
          <a href="/logistica" class="nav-link"><i class="fas fa-shipping-fast"></i><span>Envíos</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">ANÁLISIS</div></li>
        <li class="nav-item">
          <a href="/reportes" class="nav-link"><i class="fas fa-chart-bar"></i><span>Reportes</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">SISTEMA</div></li>
        <li class="nav-item">
          <a href="/configuracion" class="nav-link"><i class="fas fa-cog"></i><span>Configuración</span></a>
        </li>
      </ul>

      <div class="logout-section">
        <button class="btn-logout" onclick="/* cerrarSesion() */null">
          <i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span>
        </button>
      </div>
    </aside>

    <!-- Contenido principal -->
    <div class="main-content">
      <!-- Header superior (idéntico a Compras) -->
      <header class="page-header">
        <div class="header-left">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
          </button>
          <div>
            <h1><i class="fas fa-file-invoice"></i> Módulo de Facturación</h1>
            <div class="breadcrumb">
              <a href="/dashboard"><i class="fas fa-home"></i> Inicio</a>
              <span>/</span>
              <span>Facturación</span>
            </div>
          </div>
        </div>
        <div class="header-right">
          <button class="btn btn-primary" onclick="abrirModalNuevaFactura()" id="btnAccionPrincipal">
            <i class="fas fa-plus"></i>
            Nueva Factura
          </button>
        </div>
      </header>

      <!-- Tabs (opcional, uno solo visible para mantener idéntica barra) -->
      <div class="tabs-container">
        <div class="tabs-nav">
          <button class="tab-button active" data-tab="facturas" onclick="cambiarTab('facturas')">
            <i class="fas fa-file-invoice-dollar"></i>
            <span>Facturas</span>
            <span class="tab-badge" id="badgeFacturas">0</span>
          </button>
          <button class="tab-button" data-tab="clientes" onclick="cambiarTab('clientes')">
            <i class="fas fa-user"></i>
            <span>Clientes</span>
            <span class="tab-badge" id="badgeClientes">0</span>
          </button>
        </div>
      </div>

      <!-- TAB FACTURAS -->
      <div class="tab-content active" id="tab-facturas">
        <section class="content-section">
          <!-- Tarjetas de métricas -->
          <div class="stats-grid">
            <div class="stat-card" style="border-left-color: var(--azul-principal)">
              <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, var(--azul-principal), var(--azul-secundario));">
                  <i class="fas fa-file-invoice"></i>
                </div>
              </div>
              <div class="stat-value" id="totalFacturas">0</div>
              <div class="stat-label">Total de Facturas</div>
            </div>

            <div class="stat-card" style="border-left-color: var(--amarillo-advertencia)">
              <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, var(--amarillo-advertencia), var(--amarillo-advertencia-dark));">
                  <i class="fas fa-clock"></i>
                </div>
              </div>
              <div class="stat-value" id="facturasPendientes">0</div>
              <div class="stat-label">Pendientes de Pago</div>
            </div>

            <div class="stat-card" style="border-left-color: var(--verde-exito)">
              <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, var(--verde-exito), var(--verde-exito-gradient));">
                  <i class="fas fa-check-circle"></i>
                </div>
              </div>
              <div class="stat-value" id="facturasPagadas">0</div>
              <div class="stat-label">Pagadas</div>
            </div>

            <div class="stat-card" style="border-left-color: var(--morado)">
              <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, var(--morado), var(--morado-dark));">
                  <i class="fas fa-dollar-sign"></i>
                </div>
              </div>
              <div class="stat-value" id="montoTotalMes">$0.00</div>
              <div class="stat-label">Monto del Mes</div>
            </div>
          </div>

          <!-- Barra de búsqueda/filtros -->
          <div class="toolbar">
            <div class="search-box">
              <i class="fas fa-search input-icon"></i>
              <input type="text" class="search-input" id="searchFacturas" placeholder="Buscar por número, cliente, UUID...">
            </div>
            <div class="toolbar-actions">
              <select class="filter-select" id="estadoFilterFacturas">
                <option value="">Todos los estados</option>
                <option value="PENDIENTE">Pendiente</option>
                <option value="PAGADA">Pagada</option>
                <option value="VENCIDA">Vencida</option>
                <option value="ANULADA">Anulada</option>
              </select>
              <button class="btn btn-secondary" onclick="refrescarFacturas()">
                <i class="fas fa-sync-alt"></i>
                Actualizar
              </button>
            </div>
          </div>

          <!-- Tabla de facturas (Thymeleaf) -->
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title"><i class="fas fa-list"></i> Listado de Facturas</h3>
            </div>
            <table class="table" id="tablaFacturas">
              <thead>
                <tr>
                     <th>ID Factura</th>
                <th>ID Compra</th>
                  <th>N°</th>
                  <th>Serie</th>
                  <th>Folio</th>
                  <th>Emisión</th>
                  <th>Vence</th>
                  <th>Creación</th>
                  <th>Cliente</th>
                  <th>Subtotal</th>
                  <th>IVA</th>
                  <th>Descuento</th>
                  <th>Total</th>
                  <th>Estado</th>
                  <th>Tipo</th>
                  <th>Pago</th>
                  <th>UUID</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="facturasTableBody">
                <!-- Si no usas Thymeleaf aún, deja vacío, el JS poblará la tabla -->
                <tr th:if="${facturas == null or #lists.isEmpty(facturas)}">
                  <td colspan="15" class="empty-state">
                    <i class="fas fa-file-invoice"></i>
                    <h3>No hay facturas registradas</h3>
                    <p>Comienza creando tu primera factura</p>
                  </td>
                </tr>

                <tr th:each="f : ${facturas}">
                    <td th:text="${f.id_factura}"></td>
                <td th:text="${f.id_compra}"></td>
                  <td th:text="${f.numero_factura}"></td>
                  <td th:text="${f.serie}"></td>
                  <td th:text="${f.folio}"></td>
                  <td th:text="${f.fecha_emision != null ? #temporals.format(f.fecha_emision, 'yyyy-MM-dd') : ''}"></td>
                  <td th:text="${f.fecha_vencimiento != null ? #temporals.format(f.fecha_vencimiento, 'yyyy-MM-dd') : ''}"></td>
                   <td th:text="${#temporals.format(f.fecha_creacion, 'yyyy-MM-dd HH:mm')}"></td>
                  <td th:text="${f.id_cliente}"></td>
                  <td th:text="${#numbers.formatDecimal(f.subtotal,1,2)}"></td>
                  <td th:text="${#numbers.formatDecimal(f.impuestos,1,2)}"></td>
                  <td th:text="${#numbers.formatDecimal(f.descuentos,1,2)}"></td>
                  <td><strong style="color: var(--verde-exito)" th:text="${#numbers.formatDecimal(f.total,1,2)}"></strong></td>
                  <td th:utext="${f.estado == 'PAGADA' ? '<span class=&quot;badge badge-success&quot;><i class=&quot;fas fa-check-circle&quot;></i> Pagada</span>' :
                                  (f.estado == 'PENDIENTE' ? '<span class=&quot;badge badge-warning&quot;><i class=&quot;fas fa-clock&quot;></i> Pendiente</span>' :
                                  (f.estado == 'VENCIDA' ? '<span class=&quot;badge badge-danger&quot;><i class=&quot;fas fa-exclamation-circle&quot;></i> Vencida</span>' :
                                   '<span class=&quot;badge badge-secondary&quot;>Anulada</span>'))}"></td>
                  <td th:text="${f.tipo_factura}"></td>
                  <td th:text="${f.forma_pago}"></td>
                  <td th:text="${f.uuid_fiscal}"></td>
                  <td>
                    <a class="btn btn-icon btn-primary" th:href="@{'/factura/editar/' + ${f.id_factura}}" title="Editar"><i class="fas fa-edit"></i></a>
                    <a class="btn btn-icon btn-danger" th:href="@{'/factura/eliminar/' + ${f.id_factura}}" title="Eliminar"><i class="fas fa-trash"></i></a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- TAB CLIENTES (placeholder para mantener la misma UX de tabs que Compras) -->
      <div class="tab-content" id="tab-clientes">
        <section class="content-section">
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title"><i class="fas fa-users"></i> Clientes (placeholder)</h3>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th><th>Nombre</th><th>RFC</th><th>Teléfono</th><th>Email</th><th>Acciones</th>
                </tr>
              </thead>
              <tbody id="clientesTableBody">
                <tr>
                  <td colspan="6" class="empty-state">
                    <i class="fas fa-user"></i>
                    <h3>Sin clientes</h3>
                    <p>Integra tu listado de clientes desde tu backend</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- MODAL: Nueva/Editar Factura -->
  <div class="modal" id="modalFactura">
    <div class="modal-content" style="max-width: 960px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modalFacturaTitle">
          <i class="fas fa-plus-circle"></i> Nueva Factura
        </h3>
        <button class="modal-close" onclick="cerrarModal('modalFactura')"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-body">
        <form id="formFactura" th:action="@{/factura/guardar}" method="post">
          <input type="hidden" name="id_factura" th:value="${factura.id_factura}" />

          <div class="form-group">
        <label class="form-label"><i class="fas fa-barcode"></i> ID Compra</label>
        <input class="form-input" type="number" name="id_compra"
               th:value="${factura.id_compra}" placeholder="Ej: 1" required>
      </div>
      
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label"><i class="fas fa-hashtag"></i> Número de Factura <span class="required">*</span></label>
              <input class="form-input" name="numero_factura" required placeholder="Ej: F-0001" th:value="${factura.numero_factura}">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-layer-group"></i> Serie</label>
              <input class="form-input" name="serie" th:value="${factura.serie}" placeholder="Ej: A">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-list-ol"></i> Folio</label>
              <input class="form-input" type="number" name="folio" th:value="${factura.folio}" placeholder="Ej: 1">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-calendar"></i> Fecha Emisión</label>
              <input class="form-input" type="date" name="fecha_emision"
                     th:value="${factura != null and factura.fecha_emision != null ? #temporals.format(factura.fecha_emision, 'yyyy-MM-dd') : ''}">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-calendar-check"></i> Fecha Vencimiento</label>
              <input class="form-input" type="date" name="fecha_vencimiento"
                     th:value="${factura != null and factura.fecha_vencimiento != null ? #temporals.format(factura.fecha_vencimiento, 'yyyy-MM-dd') : ''}">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-clock"></i> Fecha Creación</label>
              <input class="form-input" type="datetime-local" name="fecha_creacion"
                     th:value="${factura != null and factura.fecha_creacion != null ? #temporals.format(factura.fecha_creacion, 'yyyy-MM-dd''T''HH:mm') : ''}">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-user"></i> ID Cliente <span class="required">*</span></label>
              <input class="form-input" type="number" name="id_cliente" required th:value="${factura.id_cliente}" placeholder="Ej: 1">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-shopping-cart"></i> ID Venta <span class="required">*</span></label>
              <input class="form-input" type="number" name="id_venta" required th:value="${factura.id_venta}" placeholder="Ej: 1">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-coins"></i> Subtotal <span class="required">*</span></label>
              <input class="form-input" type="number" step="0.01" name="subtotal" id="inpSubtotal" required th:value="${factura.subtotal}" placeholder="0.00">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-percent"></i> Impuestos (IVA)</label>
              <input class="form-input" type="number" step="0.01" name="impuestos" id="inpImpuestos" th:value="${factura.impuestos}" placeholder="0.00">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-tags"></i> Descuentos</label>
              <input class="form-input" type="number" step="0.01" name="descuentos" id="inpDescuentos" th:value="${factura.descuentos}" placeholder="0.00">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-equals"></i> Total</label>
              <input class="form-input" type="number" step="0.01" name="total" id="inpTotal" th:value="${factura.total}" placeholder="0.00">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-flag"></i> Estado</label>
              <select class="form-select" name="estado" id="inpEstado" required>
                <option th:selected="${factura.estado == 'PENDIENTE'}" value="PENDIENTE">PENDIENTE</option>
                <option th:selected="${factura.estado == 'PAGADA'}" value="PAGADA">PAGADA</option>
                <option th:selected="${factura.estado == 'VENCIDA'}" value="VENCIDA">VENCIDA</option>
                <option th:selected="${factura.estado == 'ANULADA'}" value="ANULADA">ANULADA</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-receipt"></i> Tipo Factura</label>
              <select class="form-select" name="tipo_factura" id="inpTipoFactura">
                <option th:selected="${factura.tipo_factura == 'VENTA'}" value="VENTA">VENTA</option>
                <option th:selected="${factura.tipo_factura == 'COMPRA'}" value="COMPRA">COMPRA</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-credit-card"></i> Forma de Pago</label>
              <select class="form-select" name="forma_pago" id="inpFormaPago">
                <option th:selected="${factura.forma_pago == 'EFECTIVO'}" value="EFECTIVO">EFECTIVO</option>
                <option th:selected="${factura.forma_pago == 'TARJETA'}" value="TARJETA">TARJETA</option>
                <option th:selected="${factura.forma_pago == 'TRANSFERENCIA'}" value="TRANSFERENCIA">TRANSFERENCIA</option>
                <option th:selected="${factura.forma_pago == 'MIXTO'}" value="MIXTO">MIXTO</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-book"></i> Uso CFDI</label>
              <input class="form-input" name="uso_cfdi" id="inpUsoCfdi" th:value="${factura.uso_cfdi}" placeholder="G03">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-random"></i> Método de Pago</label>
              <input class="form-input" name="metodo_pago" id="inpMetodoPago" th:value="${factura.metodo_pago}" placeholder="PUE">
            </div>

            <div class="form-group full-width">
              <label class="form-label"><i class="fas fa-fingerprint"></i> UUID Fiscal</label>
              <input class="form-input" name="uuid_fiscal" id="inpUuid" th:value="${factura.uuid_fiscal}" placeholder="UUID-XXXX-XXXX">
            </div>
          </div>
        </form>

        <div class="total-section" style="margin-top: 8px;">
          <div class="total-row"><span>Subtotal:</span><strong id="subtotalDisplay">$0.00</strong></div>
          <div class="total-row"><span>IVA (16%):</span><strong id="impuestosDisplay">$0.00</strong></div>
          <div class="total-row"><span>Descuento:</span><strong id="descuentoDisplay">$0.00</strong></div>
          <div class="total-row final"><span>TOTAL:</span><strong id="totalDisplay">$0.00</strong></div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalFactura')">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="submit" form="formFactura" class="btn btn-primary">
          <i class="fas fa-save"></i> Guardar Factura
        </button>
      </div>
    </div>
  </div>

  <script>
    // ---- Helpers visuales iguales a Compras ----
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    function cambiarTab(nombreTab) {
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-tab="${nombreTab}"]`).classList.add('active');

      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('tab-' + nombreTab).classList.add('active');

      const btn = document.getElementById('btnAccionPrincipal');
      if (nombreTab === 'facturas') {
        btn.innerHTML = '<i class="fas fa-plus"></i> Nueva Factura';
        btn.onclick = abrirModalNuevaFactura;
      } else {
        btn.innerHTML = '<i class="fas fa-user-plus"></i> Nuevo Cliente';
        btn.onclick = function(){ /* abrirModalNuevoCliente() */ };
      }
    }

    function abrirModalNuevaFactura() {
      document.getElementById('modalFacturaTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Nueva Factura';
      abrirModal('modalFactura');
      setTimeout(actualizarResumen, 50);
    }

    function abrirModal(id) {
      document.getElementById(id).classList.add('active');
    }
    function cerrarModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // ---- Búsqueda y filtro en tabla ----
    const searchInput = document.getElementById('searchFacturas');
    const estadoFilter = document.getElementById('estadoFilterFacturas');
    searchInput.addEventListener('input', filtrarTabla);
    estadoFilter.addEventListener('change', filtrarTabla);

    function filtrarTabla() {
      const q = (searchInput.value || '').toLowerCase();
      const estado = estadoFilter.value;
      const rows = [...document.querySelectorAll('#facturasTableBody tr')];

      let visibles = 0;
      rows.forEach(row => {
        // Saltar fila vacía de “no hay datos”
        if (row.classList.contains('empty')) return;

        const t = row.innerText.toLowerCase();
        const estadoCell = row.children[10]?.innerText.trim().toUpperCase() || '';

        const matchQ = t.includes(q);
        const matchEstado = !estado || estadoCell.includes(estado);
        const show = matchQ && matchEstado;

        row.style.display = show ? '' : 'none';
        if (show && row.children.length > 1) visibles++;
      });

      document.getElementById('badgeFacturas').textContent = visibles;
    }

    // ---- Cálculo automático de totales (igual UX que Compras) ----
    const inpSubtotal   = document.getElementById('inpSubtotal');
    const inpImpuestos  = document.getElementById('inpImpuestos');
    const inpDescuentos = document.getElementById('inpDescuentos');
    const inpTotal      = document.getElementById('inpTotal');

    [inpSubtotal, inpImpuestos, inpDescuentos].forEach(el => {
      if (el) el.addEventListener('input', actualizarResumen);
    });

    function actualizarResumen() {
      const subtotal   = parseFloat(inpSubtotal?.value)   || 0;
      let   impuestos  = parseFloat(inpImpuestos?.value)  || 0;
      const descuentos = parseFloat(inpDescuentos?.value) || 0;

      // Si el campo de impuestos está vacío o 0, calcula 16% automáticamente
      if ((!inpImpuestos?.value || impuestos === 0) && subtotal > 0) {
        impuestos = +(subtotal * 0.16).toFixed(2);
        if (inpImpuestos) inpImpuestos.value = impuestos.toFixed(2);
      }

      const total = Math.max(0, subtotal + impuestos - descuentos);

      if (inpTotal) inpTotal.value = total.toFixed(2);
      document.getElementById('subtotalDisplay').textContent   = '$' + subtotal.toFixed(2);
      document.getElementById('impuestosDisplay').textContent  = '$' + impuestos.toFixed(2);
      document.getElementById('descuentoDisplay').textContent  = '$' + descuentos.toFixed(2);
      document.getElementById('totalDisplay').textContent      = '$' + total.toFixed(2);
    }

    // ---- KPIs desde la tabla (cuando renderiza el servidor) ----
    function refrescarKPIsDesdeTabla() {
      const filas = [...document.querySelectorAll('#facturasTableBody tr')].filter(tr => tr.children.length > 1);
      const hoy = new Date();
      const mes = hoy.getMonth();
      const anio = hoy.getFullYear();

      let total = 0, pend = 0, pag = 0, montoMes = 0;

      filas.forEach(tr => {
        const fechaEmision = tr.children[3]?.innerText;
        const estadoTxt = tr.children[10]?.innerText?.trim().toUpperCase();
        const totalTxt = (tr.children[9]?.innerText || '0').replace('$', '').replace(',', '');
        const totalVal = parseFloat(totalTxt) || 0;

        total++;
        if (estadoTxt.includes('PENDIENTE')) pend++;
        if (estadoTxt.includes('PAGADA'))    pag++;

        // monto del mes actual
        if (fechaEmision) {
          const f = new Date(fechaEmision);
          if (f.getMonth() === mes && f.getFullYear() === anio) {
            montoMes += totalVal;
          }
        }
      });

      document.getElementById('totalFacturas').textContent = total;
      document.getElementById('facturasPendientes').textContent = pend;
      document.getElementById('facturasPagadas').textContent = pag;
      document.getElementById('montoTotalMes').textContent = '$' + montoMes.toFixed(2);
      document.getElementById('badgeFacturas').textContent = total;
    }

    function refrescarFacturas() {
      // Si más adelante cambias a fetch('/api/facturas'), puedes recargar aquí.
      refrescarKPIsDesdeTabla();
      filtrarTabla();
    }

    // ---- Acciones de UI idénticas a Compras ----
    function formatearNumero(n) {
      return (parseFloat(n) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
      refrescarKPIsDesdeTabla();
      filtrarTabla();
    });
  </script>
</body>
</html>
