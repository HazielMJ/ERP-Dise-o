<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Usuarios</title>
  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --accent:#2563eb;
      --danger:#ef4444;
      --muted:#6b7280;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:#111827; padding:24px}
    .container{max-width:1100px; margin:0 auto}
    header{display:flex;gap:16px;align-items:center; margin-bottom:18px}
    header h1{margin:0;font-size:20px}
    .card{background:var(--card); border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(15,23,42,0.06)}

    .topbar{display:flex; gap:12px; align-items:center; margin-bottom:12px}
    .search{flex:1}
    input[type="search"], input[type="text"], input[type="email"], input[type="password"], select{width:100%; padding:8px 10px; border:1px solid #e6e9ee; border-radius:8px}
    button{background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer}
    button.secondary{background:transparent; color:var(--accent); border:1px solid rgba(37,99,235,0.15)}
    button.danger{background:var(--danger)}
    table{width:100%; border-collapse:collapse; margin-top:12px}
    th, td{padding:10px 8px; text-align:left; border-bottom:1px solid #eef2f6; font-size:14px}
    th{color:var(--muted); font-weight:600}
    .actions button{margin-right:6px}
    .small{font-size:13px; color:var(--muted)}

    /* Modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(2,6,23,0.45); display:none; align-items:center; justify-content:center; z-index:40}
    .modal{width:100%; max-width:720px; background:var(--card); border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(2,6,23,0.2)}
    .modal h2{margin-top:0}
    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .form-row{margin-bottom:8px}
    .avatar-preview{width:72px; height:72px; border-radius:10px; object-fit:cover; border:1px solid #e6e9ee}
    .note{font-size:13px; color:var(--muted)}

    @media (max-width:720px){.form-grid{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Control de Usuarios</h1>
      
    </header>

    <section class="card">
      <div class="topbar">
        <div class="search">
          <input id="search" type="search" placeholder="Buscar por nombre, usuario o correo..." />
        </div>
        <div style="display:flex;gap:8px">
          <button id="btnAdd">+ Nuevo usuario</button>
          <button id="btnExport" class="secondary">Exportar CSV</button>
          <button id="btnClear" class="secondary">Borrar todo</button>
        </div>
      </div>

      <div id="tableWrap">
        <table id="usersTable">
          <thead>
            <tr>
              <th>Avatar</th>
              <th>Nombre completo</th>
              <th>Usuario</th>
              <th>Correo</th>
              <th>Rol</th>
              <th>Creado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="emptyNote" class="note" style="margin-top:12px">No hay usuarios. Crea uno nuevo con "+ Nuevo usuario".</div>
    </section>
  </div>

  
  <div id="modal" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <h2 id="modalTitle">Nuevo usuario</h2>
      <form id="userForm">
        <div class="form-grid">
          <div>
            <div class="form-row">
              <label>Nombre completo *</label>
              <input id="fullName" name="fullName" type="text" placeholder="Ej: María Pérez" required />
            </div>
            <div class="form-row">
              <label>Usuario (único) *</label>
              <input id="username" name="username" type="text" placeholder="ejemplo123" required />
            </div>
            <div class="form-row">
              <label>Correo electrónico *</label>
              <input id="email" name="email" type="email" placeholder="correo@dominio.com" required />
            </div>
            <div class="form-row">
              <label>Teléfono</label>
              <input id="phone" name="phone" type="text" placeholder="(opcional)" />
            </div>
          </div>

          <div>
            <div class="form-row">
              <label>Contraseña *</label>
              <input id="password" name="password" type="password" placeholder="mínimo 6 caracteres" required />
            </div>
            <div class="form-row">
              <label>Confirmar contraseña *</label>
              <input id="confirmPassword" name="confirmPassword" type="password" placeholder="vuelve a escribir" required />
            </div>
            <div class="form-row">
              <label>Rol *</label>
              <select id="role" name="role" required>
                <option value="">-- Selecciona --</option>
                <option value="admin">Administrador</option>
                <option value="editor">Editor</option>
                <option value="viewer">Visor</option>
              </select>
            </div>
            <div class="form-row">
              <label>Avatar (imagen)</label>
              <input id="avatarFile" type="file" accept="image/*" />
              <div style="margin-top:8px; display:flex; gap:10px; align-items:center">
                <img id="avatarPreview" class="avatar-preview" src="" alt="Avatar" />
                <div class="note">Tamaño max aproximado según navegador. Se almacena como base64 en localStorage.</div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
          <button type="button" id="btnCancel" class="secondary">Cancelar</button>
          <button type="submit" id="btnSave">Guardar usuario</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    
    const LS_KEY = 'control_usuarios_v1';

    function uid(){return Date.now().toString(36) + Math.random().toString(36).slice(2,8)}

    function loadUsers(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){console.error(e); return []}
    }
    function saveUsers(list){localStorage.setItem(LS_KEY, JSON.stringify(list))}

    
    const usersTableBody = document.querySelector('#usersTable tbody');
    const emptyNote = document.getElementById('emptyNote');
    const searchInput = document.getElementById('search');
    const btnAdd = document.getElementById('btnAdd');
    const btnExport = document.getElementById('btnExport');
    const btnClear = document.getElementById('btnClear');

    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const userForm = document.getElementById('userForm');
    const btnCancel = document.getElementById('btnCancel');
    const avatarFile = document.getElementById('avatarFile');
    const avatarPreview = document.getElementById('avatarPreview');

    const fullNameInput = document.getElementById('fullName');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const roleInput = document.getElementById('role');

    let users = loadUsers();
    let editingId = null;
    let currentAvatarData = '';

    
    function validateFullName(name){
      if(!name) return false;
      
      const parts = name.trim().split(/\s+/);
      return parts.length >= 2 && parts.every(p => p.length >= 2);
    }
    function validateEmail(email){
     
      return /\S+@\S+\.\S+/.test(email);
    }

    function usernameExists(u, excludeId=null){
      return users.some(x => x.username.toLowerCase() === u.toLowerCase() && x.id !== excludeId);
    }

    function showModal(open=true){
      modal.style.display = open ? 'flex' : 'none';
      modal.setAttribute('aria-hidden', open? 'false' : 'true');
    }

    function resetForm(){
      userForm.reset();
      editingId = null;
      currentAvatarData = '';
      avatarPreview.src = '';
      modalTitle.textContent = 'Nuevo usuario';
    }

    
    function renderTable(filter=''){
      usersTableBody.innerHTML = '';
      const f = filter.trim().toLowerCase();
      const filtered = users.filter(u => {
        if(!f) return true;
        return (u.fullName + ' ' + u.username + ' ' + u.email).toLowerCase().includes(f);
      });

      if(filtered.length === 0){
        emptyNote.style.display = 'block';
      } else {
        emptyNote.style.display = 'none';
      }

      for(const user of filtered){
        const tr = document.createElement('tr');

        const tdAvatar = document.createElement('td');
        const img = document.createElement('img');
        img.src = user.avatar || '';
        img.alt = 'avatar';
        img.style.width = '48px'; img.style.height = '48px'; img.style.borderRadius = '8px'; img.style.objectFit='cover';
        tdAvatar.appendChild(img);

        const tdName = document.createElement('td'); tdName.textContent = user.fullName;
        const tdUser = document.createElement('td'); tdUser.textContent = user.username;
        const tdEmail = document.createElement('td'); tdEmail.textContent = user.email;
        const tdRole = document.createElement('td'); tdRole.textContent = user.role;
        const tdCreated = document.createElement('td'); tdCreated.textContent = new Date(user.createdAt).toLocaleString();

        const tdActions = document.createElement('td'); tdActions.className = 'actions';
        const btnEdit = document.createElement('button'); btnEdit.textContent = 'Editar'; btnEdit.className='secondary';
        btnEdit.addEventListener('click', ()=> openEdit(user.id));

        const btnDelete = document.createElement('button'); btnDelete.textContent = 'Eliminar'; btnDelete.className='danger';
        btnDelete.addEventListener('click', ()=> removeUser(user.id));

        tdActions.appendChild(btnEdit); tdActions.appendChild(btnDelete);

        tr.appendChild(tdAvatar);
        tr.appendChild(tdName);
        tr.appendChild(tdUser);
        tr.appendChild(tdEmail);
        tr.appendChild(tdRole);
        tr.appendChild(tdCreated);
        tr.appendChild(tdActions);

        usersTableBody.appendChild(tr);
      }
    }

    
    function addUser(data){
      users.unshift(data); 
      saveUsers(users);
      renderTable(searchInput.value);
    }

    function updateUser(id, newData){
      users = users.map(u => u.id === id ? {...u, ...newData} : u);
      saveUsers(users);
      renderTable(searchInput.value);
    }

    function removeUser(id){
      if(!confirm('¿Eliminar usuario? Esta acción no se puede deshacer.')) return;
      users = users.filter(u => u.id !== id);
      saveUsers(users);
      renderTable(searchInput.value);
    }

    function openEdit(id){
      const u = users.find(x => x.id === id);
      if(!u) return alert('Usuario no encontrado');
      editingId = id;
      modalTitle.textContent = 'Editar usuario';
      fullNameInput.value = u.fullName;
      usernameInput.value = u.username;
      emailInput.value = u.email;
      phoneInput.value = u.phone || '';
      roleInput.value = u.role || '';
      
      passwordInput.value = '';
      confirmPasswordInput.value = '';
      avatarPreview.src = u.avatar || '';
      currentAvatarData = u.avatar || '';
      showModal(true);
    }

    function exportCSV(){
      if(users.length === 0) return alert('No hay usuarios para exportar');
      const rows = [['id','fullName','username','email','phone','role','createdAt']];
      for(const u of users){
        rows.push([u.id, u.fullName, u.username, u.email, u.phone || '', u.role, u.createdAt]);
      }
      const csv = rows.map(r => r.map(cell => '"' + String(cell).replace(/"/g,'""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'usuarios_export.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    
    btnAdd.addEventListener('click', ()=>{ resetForm(); showModal(true); });
    btnCancel.addEventListener('click', ()=>{ showModal(false); });

    userForm.addEventListener('submit', (e)=>{
      e.preventDefault();

      const fullName = fullNameInput.value.trim();
      const username = usernameInput.value.trim();
      const email = emailInput.value.trim();
      const phone = phoneInput.value.trim();
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      const role = roleInput.value;

      
      if(!validateFullName(fullName)) return alert('El nombre completo debe tener al menos dos palabras de 2 caracteres.');
      if(!username) return alert('El usuario es requerido.');
      if(usernameExists(username, editingId)) return alert('El nombre de usuario ya existe.');
      if(!validateEmail(email)) return alert('Correo inválido.');
      if(!role) return alert('Selecciona un rol.');

      if(!editingId){
        if(password.length < 6) return alert('La contraseña debe tener al menos 6 caracteres.');
        if(password !== confirmPassword) return alert('Contraseñas no coinciden.');
      } else {
        
        if(password){
          if(password.length < 6) return alert('La contraseña debe tener al menos 6 caracteres.');
          if(password !== confirmPassword) return alert('Contraseñas no coinciden.');
        }
      }

      const data = {
        id: editingId || uid(),
        fullName,
        username,
        email,
        phone,
        role,
        avatar: currentAvatarData || '',
        createdAt: editingId ? users.find(u=>u.id===editingId).createdAt : new Date().toISOString(),
        
      };

      if(editingId) updateUser(editingId, data);
      else addUser(data);

      showModal(false);
    });

    avatarFile.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      if(!f.type.startsWith('image/')) return alert('Selecciona una imagen.');
      const reader = new FileReader();
      reader.onload = function(ev){
        currentAvatarData = ev.target.result; // base64
        avatarPreview.src = currentAvatarData;
      };
      reader.readAsDataURL(f);
    });

    searchInput.addEventListener('input', (e)=>{
      renderTable(e.target.value);
    });

    btnExport.addEventListener('click', exportCSV);

    btnClear.addEventListener('click', ()=>{
      if(!confirm('¿Borrar todos los usuarios?')) return;
      users = [];
      saveUsers(users);
      renderTable();
    });

    
    renderTable();

    
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') showModal(false);
    });

    
    if(users.length === 0){
      const demo = {
        id: uid(),
        fullName: 'Admin Demo',
        username: 'admin',
        email: 'admin@ejemplo.com',
        phone: '',
        role: 'admin',
        avatar: '',
        createdAt: new Date().toISOString()
      };
      users.push(demo); saveUsers(users); renderTable();
    }

  </script>
</body>
</html>

