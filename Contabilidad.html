<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Módulo de Contabilidad - ERP</title>

  <!-- Iconos y estilos idénticos a Compras -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/ComprasStyle.css}">
</head>
<body>
  <div class="main-container">

    <!-- Sidebar (mismo marcado que Compras) -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-chart-line"></i> ERP System</h2>
        <p>Sistema Integral de Gestión</p>
      </div>

      <ul class="nav-menu">
        <li class="nav-section"><div class="nav-section-title">PRINCIPAL</div></li>
        <li class="nav-item">
          <a href="/dashboard" class="nav-link">
            <i class="fas fa-tachometer-alt"></i><span>Dashboard</span>
          </a>
        </li>

        <li class="nav-section"><div class="nav-section-title">ADMINISTRACIÓN</div></li>
        <li class="nav-item">
          <a href="/usuarios" class="nav-link">
            <i class="fas fa-user-shield"></i><span>Usuarios</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="/contabilidad" class="nav-link active">
            <i class="fas fa-calculator"></i><span>Contabilidad</span>
          </a>
        </li>
      <li class="nav-item">
  <a href="/impuesto" class="nav-link">
    <i class="fas fa-percent"></i><span>Impuestos</span>
  </a>
</li>


        <li class="nav-section"><div class="nav-section-title">VENTAS</div></li>
        <li class="nav-item">
          <a href="/clientes" class="nav-link"><i class="fas fa-users"></i><span>Clientes</span></a>
        </li>
        <li class="nav-item">
          <a href="/ventas" class="nav-link"><i class="fas fa-shopping-cart"></i><span>Ventas</span></a>
        </li>
        <li class="nav-item">
          <a href="/factura" class="nav-link"><i class="fas fa-file-invoice"></i><span>Facturación</span></a>
        </li>
        <li class="nav-item">
          <a href="/punto-venta" class="nav-link"><i class="fas fa-cash-register"></i><span>Punto de Venta</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">INVENTARIO</div></li>
        <li class="nav-item">
          <a href="/inventario" class="nav-link"><i class="fas fa-boxes"></i><span>Inventario</span></a>
        </li>
        <li class="nav-item">
          <a href="/almacenes" class="nav-link"><i class="fas fa-warehouse"></i><span>Almacenes</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">RECURSOS HUMANOS</div></li>
        <li class="nav-item">
          <a href="/rrhh" class="nav-link"><i class="fas fa-user-tie"></i><span>Empleados</span></a>
        </li>
        <li class="nav-item">
          <a href="/nomina" class="nav-link"><i class="fas fa-money-bill-wave"></i><span>Nómina</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">ANÁLISIS</div></li>
        <li class="nav-item">
          <a href="/reportes" class="nav-link"><i class="fas fa-chart-bar"></i><span>Reportes</span></a>
        </li>

        <li class="nav-section"><div class="nav-section-title">SISTEMA</div></li>
        <li class="nav-item">
          <a href="/configuracion" class="nav-link"><i class="fas fa-cog"></i><span>Configuración</span></a>
        </li>
      </ul>

      <div class="logout-section">
        <button class="btn-logout" onclick="cerrarSesion()">
          <i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span>
        </button>
      </div>
    </aside>

    <!-- Contenido principal -->
    <div class="main-content">
      <!-- Header superior (igual a Compras) -->
      <header class="page-header">
        <div class="header-left">
          <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
          <div>
            <h1><i class="fas fa-calculator"></i> Módulo de Contabilidad</h1>
            <div class="breadcrumb">
              <a href="/dashboard"><i class="fas fa-home"></i> Inicio</a>
              <span>/</span><span>Contabilidad</span>
            </div>
          </div>
        </div>
        <div class="header-right">
          <button class="btn btn-primary" id="btnAccionPrincipal" onclick="abrirModalAsiento()">
            <i class="fas fa-plus"></i>
            Nuevo Asiento
          </button>
        </div>
      </header>

      <!-- Tabs idénticos a Compras -->
      <div class="tabs-container">
        <div class="tabs-nav">
          <button class="tab-button active" data-tab="contabilidad" onclick="cambiarTab('contabilidad')">
            <i class="fas fa-book"></i><span>Contabilidad</span>
            <span class="tab-badge" id="badgeAsientos" th:text="${#lists.size(contabilidades)}">0</span>
          </button>
          <button class="tab-button" data-tab="detalle" onclick="cambiarTab('detalle')">
            <i class="fas fa-list-ol"></i><span>Detalle Contable</span>
            <span class="tab-badge" id="badgeDetalles" th:text="${#lists.size(detallecontable)}">0</span>
          </button>
        </div>
      </div>

      <!-- TAB: Contabilidad -->
      <div class="tab-content active" id="tab-contabilidad">
        <section class="content-section">
          <!-- Toolbar con buscador y filtro de estado -->
          <div class="toolbar">
            <div class="search-box">
              <i class="fas fa-search input-icon"></i>
              <input type="text" class="search-input" id="searchAsientos" placeholder="Buscar por número, descripción o periodo..." oninput="filtrarAsientos()">
            </div>
            <div class="toolbar-actions">
              <select class="filter-select" id="estadoFilterAsiento" onchange="filtrarAsientos()">
                <option value="">Todos los estados</option>
                <option value="BORRADOR">Borrador</option>
                <option value="CONTABILIZADO">Contabilizado</option>
                <option value="ANULADO">Anulado</option>
              </select>
              <button class="btn btn-secondary" onclick="refrescarListas()">
                <i class="fas fa-sync-alt"></i> Actualizar
              </button>
            </div>
          </div>

          <!-- Tabla de asientos -->
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title"><i class="fas fa-table"></i> Listado de Asientos</h3>
              <button class="btn btn-success btn-sm" onclick="abrirModalAsiento()">
                <i class="fas fa-plus"></i> Nuevo Asiento
              </button>
            </div>

            <table class="table" id="tablaAsientos">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Fecha</th>
                  <th>Número</th>
                  <th>Descripción</th>
                  <th>Usuario</th>
                  <th>Debe</th>
                  <th>Haber</th>
                  <th>Periodo</th>
                  <th>Fecha Cont.</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="asientosBody">
                <tr th:each="c : ${contabilidades}">
                  <td th:text="${c.id_asiento}">1</td>
                  <td th:text="${#dates.format(c.fecha_asiento,'yyyy-MM-dd')}">2025-01-01</td>
                  <td th:text="${c.numero_asiento}">AS-0001</td>
                  <td th:text="${c.descripcion}">Poliza ejemplo</td>
                  <td th:text="${c.id_usuario}">1</td>
                  <td th:text="${c.total_debe}">0.00</td>
                  <td th:text="${c.total_haber}">0.00</td>
                  <td th:text="${c.periodo_contable}">2025-11</td>
                  <td th:text="${c.fecha_contabilizacion != null ? #dates.format(c.fecha_contabilizacion,'yyyy-MM-dd HH:mm') : ''}"></td>
                  <td>
                    <span th:classappend="${c.estado=='CONTABILIZADO'} ? 'badge badge-success' : (${c.estado=='BORRADOR'} ? 'badge badge-warning' : 'badge badge-danger')"
                          th:text="${c.estado}">BORRADOR</span>
                  </td>
                  <td>
                    <a th:href="@{'/contabilidad/eliminar/' + ${c.id_asiento}}" class="btn btn-icon btn-danger" title="Eliminar">
                      <i class="fas fa-trash"></i>
                    </a>
                  </td>
                </tr>
                <!-- Estado vacío -->
                <tr th:if="${#lists.isEmpty(contabilidades)}">
                  <td colspan="11" class="empty-state">
                    <i class="fas fa-book"></i>
                    <h3>No hay asientos registrados</h3>
                    <p>Crea tu primer asiento contable</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- TAB: Detalle Contable -->
      <div class="tab-content" id="tab-detalle">
        <section class="content-section">
          <div class="toolbar">
            <div class="search-box">
              <i class="fas fa-search input-icon"></i>
              <input type="text" class="search-input" id="searchDetalle" placeholder="Buscar por cuenta o descripción..." oninput="filtrarDetalle()">
            </div>
            <div class="toolbar-actions">
              <button class="btn btn-secondary" onclick="refrescarListas()">
                <i class="fas fa-sync-alt"></i> Actualizar
              </button>
              <button class="btn btn-success" onclick="abrirModalDetalle()">
                <i class="fas fa-plus"></i> Nuevo Movimiento
              </button>
            </div>
          </div>

          <div th:if="${error}" class="badge badge-danger" th:text="${error}"></div>
          <div th:if="${exito}" class="badge badge-success" th:text="${exito}"></div>

          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title"><i class="fas fa-list"></i> Movimientos</h3>
            </div>
            <table class="table" id="tablaDetalle">
              <thead>
              <tr>
                <th>ID</th>
                <th>ID Asiento</th>
                <th>Línea</th>
                <th>Cuenta</th>
                <th>Descripción</th>
                <th>Debe</th>
                <th>Haber</th>
                <th>Acciones</th>
              </tr>
              </thead>
              <tbody id="detalleBody">
              <tr th:each="d : ${detallecontable}">
                <td th:text="${d.id_detalle}">1</td>
                <td th:text="${d.id_asiento}">1</td>
                <td th:text="${d.numero_linea}">1</td>
                <td th:text="${d.cuenta_contable}">1101</td>
                <td th:text="${d.descripcion_linea}">Caja</td>
                <td th:text="${d.debe}">0.00</td>
                <td th:text="${d.haber}">0.00</td>
                <td>
                  <a th:href="@{'/detallecontable/eliminar/' + ${d.id_detalle}}" class="btn btn-icon btn-danger" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </a>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(detallecontable)}">
                <td colspan="8" class="empty-state">
                  <i class="fas fa-list-ol"></i>
                  <h3>No hay movimientos registrados</h3>
                  <p>Agrega un movimiento al asiento correspondiente</p>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- MODAL: Nuevo Asiento (Contabilidad) -->
  <div class="modal" id="modalAsiento">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-plus-circle"></i> Nuevo Asiento</h3>
        <button class="modal-close" onclick="cerrarModal('modalAsiento')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form th:action="@{/contabilidad/guardar}" method="post" id="formAsiento">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Fecha Asiento <span class="required">*</span></label>
              <input type="date" class="form-input" name="fecha_asiento" required>
            </div>
            <div class="form-group">
              <label class="form-label">Número Asiento <span class="required">*</span></label>
              <input type="text" class="form-input" name="numero_asiento" placeholder="AS-0001" required>
            </div>
            <div class="form-group">
              <label class="form-label">ID Usuario <span class="required">*</span></label>
              <input type="number" class="form-input" name="id_usuario" value="1" required>
            </div>
            <div class="form-group">
              <label class="form-label">Periodo Contable</label>
              <input type="text" class="form-input" name="periodo_contable" placeholder="YYYY-MM">
            </div>
            <div class="form-group">
              <label class="form-label">Total Debe</label>
              <input type="number" class="form-input" step="0.01" name="total_debe" value="0">
            </div>
            <div class="form-group">
              <label class="form-label">Total Haber</label>
              <input type="number" class="form-input" step="0.01" name="total_haber" value="0">
            </div>
            <div class="form-group">
              <label class="form-label">Fecha Contabilización</label>
              <input type="datetime-local" class="form-input" name="fecha_contabilizacion">
            </div>
            <div class="form-group">
              <label class="form-label">Estado</label>
              <select class="form-select" name="estado">
                <option value="BORRADOR">BORRADOR</option>
                <option value="CONTABILIZADO">CONTABILIZADO</option>
                <option value="ANULADO">ANULADO</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label class="form-label">Descripción</label>
              <textarea class="form-textarea" name="descripcion" placeholder="Descripción del asiento..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalAsiento')"><i class="fas fa-times"></i> Cancelar</button>
        <button type="submit" form="formAsiento" class="btn btn-primary"><i class="fas fa-save"></i> Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Nuevo Movimiento (Detalle Contable) -->
  <div class="modal" id="modalDetalle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-plus-circle"></i> Nuevo Movimiento</h3>
        <button class="modal-close" onclick="cerrarModal('modalDetalle')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form th:action="@{/detallecontable/guardar}" method="post" id="formDetalle">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">ID Asiento <span class="required">*</span></label>
              <input type="number" class="form-input" name="id_asiento" required>
            </div>
            <div class="form-group">
              <label class="form-label">Número Línea</label>
              <input type="number" class="form-input" name="numero_linea" min="1">
            </div>
            <div class="form-group">
              <label class="form-label">Cuenta Contable</label>
              <input type="text" class="form-input" name="cuenta_contable" placeholder="Ej. 1101">
            </div>
            <div class="form-group">
              <label class="form-label">Debe</label>
              <input type="number" class="form-input" step="0.01" name="debe" value="0">
            </div>
            <div class="form-group">
              <label class="form-label">Haber</label>
              <input type="number" class="form-input" step="0.01" name="haber" value="0">
            </div>
            <div class="form-group full-width">
              <label class="form-label">Descripción Línea</label>
              <input type="text" class="form-input" name="descripcion_linea" placeholder="Detalle del movimiento">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalDetalle')"><i class="fas fa-times"></i> Cancelar</button>
        <button type="submit" form="formDetalle" class="btn btn-primary"><i class="fas fa-save"></i> Guardar</button>
      </div>
    </div>
  </div>

  <!-- JS: mismos patrones de Compras -->
  <script>
    function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); }

    function cambiarTab(nombre){
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.querySelector('[data-tab="'+nombre+'"]').classList.add('active');
      document.getElementById('tab-'+nombre).classList.add('active');

      const btn = document.getElementById('btnAccionPrincipal');
      if(nombre === 'contabilidad'){
        btn.innerHTML = '<i class="fas fa-plus"></i> Nuevo Asiento';
        btn.onclick = abrirModalAsiento;
      }else{
        btn.innerHTML = '<i class="fas fa-plus"></i> Nuevo Movimiento';
        btn.onclick = abrirModalDetalle;
      }
    }

    function abrirModalAsiento(){ document.getElementById('modalAsiento').classList.add('active'); }
    function abrirModalDetalle(){ document.getElementById('modalDetalle').classList.add('active'); }
    function cerrarModal(id){ document.getElementById(id).classList.remove('active'); }

    function refrescarListas(){ location.reload(); }

    // Filtros rápidos en cliente (opcional; no altera el backend)
    function filtrarAsientos(){
      const term = document.getElementById('searchAsientos').value.toLowerCase();
      const estado = document.getElementById('estadoFilterAsiento').value;
      const rows = document.querySelectorAll('#asientosBody tr[th\\:each], #asientosBody tr[data-row]');
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        if(!tds.length) return;
        const numero = (tds[2].innerText||'').toLowerCase();
        const desc   = (tds[3].innerText||'').toLowerCase();
        const periodo= (tds[7].innerText||'').toLowerCase();
        const estTxt = (tds[9].innerText||'').toUpperCase();
        const matchSearch = !term || numero.includes(term) || desc.includes(term) || periodo.includes(term);
        const matchEstado = !estado || estTxt.includes(estado);
        tr.style.display = (matchSearch && matchEstado) ? '' : 'none';
      });
    }

    function filtrarDetalle(){
      const term = document.getElementById('searchDetalle').value.toLowerCase();
      const rows = document.querySelectorAll('#detalleBody tr[th\\:each], #detalleBody tr[data-row]');
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        if(!tds.length) return;
        const cuenta = (tds[3].innerText||'').toLowerCase();
        const desc   = (tds[4].innerText||'').toLowerCase();
        tr.style.display = (!term || cuenta.includes(term) || desc.includes(term)) ? '' : 'none';
      });
    }
  </script>
</body>
</html>
