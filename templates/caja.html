<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ERP - Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/Estilodash.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-chart-line"></i> ERP System</h2>
                <p>Sistema Integral de Gesti√≥n</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-section">
                    <div class="nav-section-title">PRINCIPAL</div>
                </li>
                <li class="nav-item">
                    <a href="/" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                
                <li class="nav-section">
                    <div class="nav-section-title">ADMINISTRACI√ìN</div>
                </li>
                <li class="nav-item">
                    <a class="nav-link">
                        <i class="fas fa-user-shield"></i>
                        <span>Usuarios</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link">
                        <i class="fas fa-calculator"></i>
                        <span>Contabilidad</span>
                    </a>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">VENTAS</div>
                </li>
                <li class="nav-item">
                    <a href="/Clientes" class="nav-link">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/ventas" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Ventas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/facturacion" class="nav-link">
                        <i class="fas fa-file-invoice"></i>
                        <span>Facturaci√≥n</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/caja" class="nav-link active">
                        <i class="fas fa-cash-register"></i>
                        <span>Punto de Venta</span>
                    </a>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">COMPRAS</div>
                </li>
                <li class="nav-item">
                    <a class="nav-link">
                        <i class="fas fa-truck"></i>
                        <span>Proveedores</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link">
                        <i class="fa-sharp fa-solid fa-bag-shopping"></i>
                        <span>Compras</span>
                    </a>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">INVENTARIO</div>
                </li>
                <li class="nav-item">
                    <a href="/productos" class="nav-link">
                        <i class="fas fa-boxes"></i>
                        <span>Inventario</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/almacen " class="nav-link">
                        <i class="fas fa-warehouse"></i>
                        <span>Almacenes</span>
                    </a>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">RECURSOS HUMANOS</div>
                </li>
                <li class="nav-item">
                    <a href="/empleados" class="nav-link">
                        <i class="fas fa-user-tie"></i>
                        <span>Empleados</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/nomina" class="nav-link">
                        <i class="fa-sharp fa-solid fa-money-bill-wave"></i>
                        <span>N√≥mina</span>
                    </a>
                </li>
                <li class="nav-section">
                    <div class="nav-section-title">LOG√çSTICA</div>
                </li>
                <li class="nav-item">
                    <a href="/logistica" class="nav-link">
                        <i class="fa-sharp fa-solid fa-truck-fast"></i>
                        <span>Env√≠os</span>
                    </a>
                </li>

                <li class="nav-section">
                    <div class="nav-section-title">AN√ÅLISIS</div>
                </li>
                <li class="nav-item">
                    <a class="nav-link">
                        <i class="fa-sharp fa-solid fa-gear"></i>
                        <span>Reportes</span>
                    </a>
                </li>
                                <li class="nav-section">
                    <div class="nav-section-title">SISTEMA</div>
                </li>
                <li class="nav-item">
                    <a class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Configuraci√≥n</span>
                    </a>
                </li>
            </ul>
            
            
            <!-- Bot√≥n de cerrar sesi√≥n -->
            <div class="logout-section">
                <button class="btn-logout" onclick="cerrarSesion()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesi√≥n</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1><i class="fas fa-tachometer-alt"></i>Caja</h1>
                        <div class="breadcrumb">
                            <a href="/"><i class="fas fa-home"></i> Inicio</a>
                            <span>/</span>
                            <span>Caja</span>
                        </div>
                    </div>
                </div>
            </header>
<section class="content-section">
<div class="tab-content active">

    <div class="toolbar-actions mb-20"> <button id="toggleCajaBtn" class="btn btn-primary" data-open="false">
            <i class="fa-solid fa-plus" aria-hidden="true"></i>
            <span class="btn-label">Nueva Caja</span>
        </button>
    </div>

    <div class="table-container">
        <div class="table-header">
            <div class="table-title">
                <i class="fas fa-cash-register"></i> Cajas
            </div>
        </div>
        <table id="tablaCajas" class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>N√∫mero</th>
                    <th>Nombre</th>
                    <th>Ubicaci√≥n</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div id="cajaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-cash-register"></i>
                    <span id="cajaFormTitulo">Agregar Caja</span>
                </h3>
                <button type="button" class="modal-close" id="cerrarCajaBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="cajaAlerta" class="alert-box alert-warning" style="display:none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="cajaAlertaMsg">Completa los campos obligatorios.</span>
                </div>
                
                <form id="cajaForm">
                    <input type="hidden" id="idCaja">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="numeroCaja" class="form-label">N√∫mero de Caja <span class="required">*</span></label>
                            <input type="text" id="numeroCaja" class="form-input" placeholder="Ej. CAJ-01" required>
                        </div>
                        <div class="form-group">
                            <label for="nombreCaja" class="form-label">Nombre de Caja <span class="required">*</span></label>
                            <input type="text" id="nombreCaja" class="form-input" placeholder="Caja Principal" required>
                        </div>
                        <div class="form-group">
                            <label for="ubicacion" class="form-label">Ubicaci√≥n</label>
                            <input type="text" id="ubicacion" class="form-input" placeholder="Mostrador A">
                        </div>
                        <div class="form-group">
                            <label for="estado" class="form-label">Estado</label>
                            <select id="estado" class="form-select" required>
                                <option value="ACTIVA">ACTIVA</option>
                                <option value="INACTIVA">INACTIVA</option>
                                <option value="MANTENIMIENTO">MANTENIMIENTO</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="guardarCajaBtn" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button type="button" id="cancelarCajaBtn" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="aperturaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-door-open"></i> Apertura de Caja
                </h3>
                <button type="button" class="modal-close" id="cerrarAperturaBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="aperturaCajaForm">
                    <input type="hidden" id="idCajaApertura">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Saldo Inicial <span class="required">*</span></label>
                            <input type="number" id="saldoInicial" class="form-input" placeholder="0.00" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Observaciones</label>
                            <textarea id="observacionesApertura" class="form-input" rows="2" placeholder="Notas u observaciones..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="submitAperturaBtn" class="btn btn-success">
                    <i class="fas fa-door-open"></i> Abrir Caja
                </button>
                <button type="button" id="cancelarAperturaBtn" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

</div>
</section>

    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function cerrarSesion() {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                showNotification('Cerrando sesi√≥n...', 'info');
                setTimeout(() => {
                    showNotification('Sesi√≥n cerrada exitosamente. ¬°Hasta pronto!', 'success');
                }, 1000);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            let bgColor = 'var(--azul-principal)';
            let icon = 'fa-info-circle';
            
            if (type === 'success') {
                bgColor = 'var(--verde-exito)';
                icon = 'fa-check-circle';
            } else if (type === 'error') {
                bgColor = 'var(--rojo-peligro)';
                icon = 'fa-exclamation-circle';
            } else if (type === 'warning') {
                bgColor = 'var(--amarillo-advertencia)';
                icon = 'fa-exclamation-triangle';
            }
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: ${type === 'warning' ? 'var(--gris-texto)' : 'white'};
                padding: 18px 24px;
                border-radius: 12px;
                box-shadow: 0 6px 25px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.4s ease;
                max-width: 350px;
                white-space: pre-line;
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 500;
            `;
            
            notification.innerHTML = `
                <i class="fas ${icon}" style="font-size: 20px;"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.4s ease';
                setTimeout(() => notification.remove(), 400);
            }, 3500);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach((card, index) => {
                card.style.animation = `fadeIn 0.5s ease ${index * 0.1}s forwards`;
                card.style.opacity = '0';
            });

            setTimeout(() => {
                showNotification('¬°Bienvenido al Sistema ERP! üöÄ', 'success');
            }, 800);
        });

        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768) {
                if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                    sidebar.classList.remove('active');
                }
            }
        });

        console.log('%cüöÄ Sistema ERP Dashboard', 'color: #4a90e2; font-size: 20px; font-weight: bold;');
        console.log('%c‚ú® Sistema cargado exitosamente', 'color: #28a745; font-size: 14px;');

document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'http://localhost:8082/api/cajas';
    const API_APERTURA = 'http://localhost:8082/api/aperturas';

    const cajaModal = document.getElementById('cajaModal');
    const abrirCajaBtn = document.getElementById('toggleCajaBtn');
    const cerrarCajaBtn = document.getElementById('cerrarCajaBtn');
    const guardarCajaBtn = document.getElementById('guardarCajaBtn');
    const cancelarCajaBtn = document.getElementById('cancelarCajaBtn');
    const form = document.getElementById('cajaForm');
    const titulo = document.getElementById('cajaFormTitulo');
    const alerta = document.getElementById('cajaAlerta');
    const alertaMsg = document.getElementById('cajaAlertaMsg');
    const tbody = document.querySelector('#tablaCajas tbody');

    const idCaja = document.getElementById('idCaja');
    const numeroCaja = document.getElementById('numeroCaja');
    const nombreCaja = document.getElementById('nombreCaja');
    const ubicacion = document.getElementById('ubicacion');
    const estado = document.getElementById('estado');

    const aperturaModal = document.getElementById('aperturaModal');
    const cerrarAperturaBtn = document.getElementById('cerrarAperturaBtn');
    const submitAperturaBtn = document.getElementById('submitAperturaBtn');
    const cancelarAperturaBtn = document.getElementById('cancelarAperturaBtn');
    const aperturaForm = document.getElementById('aperturaCajaForm');
    const idCajaApertura = document.getElementById('idCajaApertura');
    const saldoInicial = document.getElementById('saldoInicial');
    const observacionesApertura = document.getElementById('observacionesApertura');

    function abrirModalCaja() {
        form.reset();
        idCaja.value = '';
        titulo.textContent = 'Agregar Caja';
        hideAlerta();
        cajaModal.classList.add('active');
    }

    function cerrarModalCaja() {
        cajaModal.classList.remove('active');
        hideAlerta();
    }

    function abrirModalApertura(id) {
        aperturaForm.reset();
        idCajaApertura.value = id;
        aperturaModal.classList.add('active');
    }
    
    function cerrarModalApertura() {
        aperturaModal.classList.remove('active');
    }

    function showAlerta(msg, type = 'warning') {
        alerta.classList.remove('alert-info','alert-success','alert-warning','alert-danger');
        alerta.classList.add(`alert-${type}`);
        alertaMsg.textContent = msg;
        alerta.style.display = 'flex';
    }
    function hideAlerta() { alerta.style.display = 'none'; }

    function badgeEstado(est) {
        if (est === 'ACTIVA') return '<span class="badge badge-success">ACTIVA</span>';
        if (est === 'INACTIVA') return '<span class="badge badge-danger">INACTIVA</span>';
        return '<span class="badge badge-warning">MANTENIMIENTO</span>';
    }

 function filaCajaHTML(c) {

    
    const id = c.idCaja ?? c.id_caja ?? c.id;
    const numero = c.numeroCaja ?? c.numero_caja ?? c.numero; 
    const nombre = c.nombreCaja ?? c.nombre_caja ?? c.nombre; 

    return `
        <tr data-id="${id}">
            <td>${id}</td>
            <td>${numero}</td>
            <td>${nombre}</td>
            <td>${c.ubicacion ?? ''}</td>
            <td>${badgeEstado(c.estado)}</td>
            <td class="action-buttons" style="display: flex; gap: 5px;">
                <button type="button" class="btn btn-sm btn-primary" data-action="apertura">
                    <i class="fas fa-door-open"></i> Apertura
                </button>
                <button type="button" class="btn btn-sm btn-secondary" data-action="edit">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" class="btn btn-sm btn-danger" data-action="del">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </td>
        </tr>
    `;
}

    async function cargarCajas() {
        try {
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error(`Error ${res.status}`);
            const data = await res.json();
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-cash-register"></i><h3>No hay cajas</h3><p>Crea la primera caja para empezar.</p></td></tr>';
                return;
            }
            tbody.innerHTML = data.map(filaCajaHTML).join('');
        } catch(err) {
            tbody.innerHTML = `<tr><td colspan="6" class="empty-state alert-danger"><i class="fas fa-exclamation-triangle"></i><h3>Error al cargar</h3><p>No se pudieron cargar las cajas.</p></td></tr>`;
        }
    }

    function validar() {
        const errores = [];
        if (!numeroCaja.value.trim()) errores.push('El n√∫mero de caja es obligatorio.');
        if (!nombreCaja.value.trim()) errores.push('El nombre de caja es obligatorio.');
        if (!estado.value) errores.push('Selecciona un estado.');
        if (errores.length) { showAlerta(errores.join('\n'), 'warning'); return false; }
        hideAlerta(); return true;
    }

async function guardarCaja() {
        if (!validar()) return;
        
        const payload = {
  numero_caja: numeroCaja.value.trim(),
  nombre_caja: nombreCaja.value.trim(),
  ubicacion: ubicacion.value.trim(),
  estado: estado.value
};

        const id = idCaja.value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/${id}` : API_URL;

        try {
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!res.ok) {
                const errorMsg = await res.text(); 
                throw new Error(errorMsg || `Error ${res.status}`);
            }
            
            if (typeof showNotification === 'function') {
                showNotification('Caja guardada correctamente.', 'success');
            }
            await cargarCajas();
            cerrarModalCaja();
            
        } catch (err) {
            showAlerta(`No se pudo guardar la caja. Error: ${err.message}`, 'danger');
        }
    }

    tbody.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const tr = btn.closest('tr');
    const id = tr?.dataset?.id;
    if (!id) { showNotification('No se encontr√≥ el id de la caja.', 'danger'); return; }

    if (btn.dataset.action === 'apertura') {
        abrirModalApertura(id);
        return;
    }


    if (btn.dataset.action === 'edit') {
        try {
            const res = await fetch(`${API_URL}/${id}`);
            if (!res.ok) throw new Error("No se pudo cargar la info de la API");
            const c = await res.json(); 
            
            idCaja.value = c.id_caja ?? '';
            numeroCaja.value = c.numero_caja ?? '';
            nombreCaja.value = c.nombre_caja ?? '';
            ubicacion.value = c.ubicacion ?? '';
            estado.value = c.estado ?? 'ACTIVA';

            titulo.textContent = 'Editar Caja';
            hideAlerta();
            cajaModal.classList.add('active');
        } catch(err) {
            console.error("Error al cargar para editar:", err);
            showNotification('No se pudo cargar la caja para editar.', 'danger');
        }
        return;
    }

        if (btn.dataset.action === 'del') {
            if (!confirm('¬øEliminar caja?')) return;
            try {
                const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error(`Error ${res.status}`);
                await cargarCajas();
                showNotification('Caja eliminada.', 'success');
            } catch {
                showNotification('No se pudo eliminar la caja.', 'danger');
            }
        }
    });
    
    async function submitApertura() {
        const payload = {
            id_caja: parseInt(idCajaApertura.value, 10),
            saldo_inicial: parseFloat(saldoInicial.value),
            observaciones: observacionesApertura.value.trim(),
        };
        
        if (isNaN(payload.id_caja) || isNaN(payload.saldo_inicial) || payload.saldo_inicial < 0) {
             alert("Por favor, introduce un saldo inicial v√°lido.");
             return;
        }

        try {
            const res = await fetch(API_APERTURA, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(`Error ${res.status}`);
            
            showNotification('Caja abierta correctamente.', 'success');
            cerrarModalApertura();
        } catch (err) {
            console.error(err);
            alert(`No se pudo abrir la caja. ${err.message}`);
        }
    }

    abrirCajaBtn.addEventListener('click', abrirModalCaja);
    cerrarCajaBtn.addEventListener('click', cerrarModalCaja);
    cancelarCajaBtn.addEventListener('click', cerrarModalCaja);
    guardarCajaBtn.addEventListener('click', guardarCaja);
    cajaModal.addEventListener('click', (e) => {
        if (e.target === cajaModal) cerrarModalCaja();
    });

    cerrarAperturaBtn.addEventListener('click', cerrarModalApertura);
    cancelarAperturaBtn.addEventListener('click', cerrarModalApertura);
    submitAperturaBtn.addEventListener('click', submitApertura);
    aperturaModal.addEventListener('click', (e) => {
        if (e.target === aperturaModal) cerrarModalApertura();
    });

    cargarCajas();
});
</script>

</body>
</html>
