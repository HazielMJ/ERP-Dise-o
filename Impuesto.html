<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Módulo de Impuestos - Sistema ERP</title>
  <!-- Iconos y estilos tal cual Compras -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Si tu CSS está en /css, cambia a th:href="@{/css/ComprasStyle.css}" -->
  <link rel="stylesheet" th:href="@{/css/ComprasStyle.css}">
</head>
<body>
  <div class="main-container">
    <!-- Sidebar (idéntico a Compras, marcando Impuestos como activo) -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-chart-line"></i> ERP System</h2>
        <p>Sistema Integral de Gestión</p>
      </div>

      <ul class="nav-menu">
        <li class="nav-section"><div class="nav-section-title">PRINCIPAL</div></li>
        <li class="nav-item">
          <a href="/dashboard" class="nav-link">
            <i class="fas fa-tachometer-alt"></i><span>Dashboard</span>
          </a>
        </li>

        <li class="nav-section"><div class="nav-section-title">ADMINISTRACIÓN</div></li>
        <li class="nav-item">
          <a href="/usuarios" class="nav-link">
            <i class="fas fa-user-shield"></i><span>Usuarios</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="/contabilidad" class="nav-link">
            <i class="fas fa-calculator"></i><span>Contabilidad</span>
          </a>
        </li>
<li class="nav-item">
  <a href="/impuesto" class="nav-link">
    <i class="fas fa-percent"></i><span>Impuestos</span>
  </a>
</li>

        <li class="nav-section"><div class="nav-section-title">VENTAS</div></li>
        <li class="nav-item">
          <a href="/clientes" class="nav-link">
            <i class="fas fa-users"></i><span>Clientes</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="/ventas" class="nav-link">
            <i class="fas fa-shopping-cart"></i><span>Ventas</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="/factura" class="nav-link">
            <i class="fas fa-file-invoice"></i><span>Facturación</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="/punto-venta" class="nav-link">
            <i class="fas fa-cash-register"></i><span>Punto de Venta</span>
          </a>
        </li>

        <li class="nav-section"><div class="nav-section-title">COMPRAS</div></li>
        <li class="nav-item">
          <a href="/proveedores" class="nav-link">
            <i class="fas fa-truck"></i><span>Proveedores</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="/compras" class="nav-link">
            <i class="fas fa-shopping-bag"></i><span>Compras</span>
          </a>
        </li>

        <li class="nav-section"><div class="nav-section-title">INVENTARIO</div></li>
        <li class="nav-item">
          <a href="/inventario" class="nav-link">
            <i class="fas fa-boxes"></i><span>Inventario</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="/almacenes" class="nav-link">
            <i class="fas fa-warehouse"></i><span>Almacenes</span>
          </a>
        </li>

        <li class="nav-section"><div class="nav-section-title">RECURSOS HUMANOS</div></li>
        <li class="nav-item">
          <a href="/rrhh" class="nav-link">
            <i class="fas fa-user-tie"></i><span>Empleados</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="/nomina" class="nav-link">
            <i class="fas fa-money-bill-wave"></i><span>Nómina</span>
          </a>
        </li>

        <li class="nav-section"><div class="nav-section-title">ANÁLISIS</div></li>
        <li class="nav-item">
          <a href="/reportes" class="nav-link">
            <i class="fas fa-chart-bar"></i><span>Reportes</span>
          </a>
        </li>

        <li class="nav-section"><div class="nav-section-title">SISTEMA</div></li>
        <li class="nav-item">
          <a href="/configuracion" class="nav-link">
            <i class="fas fa-cog"></i><span>Configuración</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="/impuesto" class="nav-link active">
            <i class="fas fa-percent"></i><span>Impuestos</span>
          </a>
        </li>
      </ul>

      <div class="logout-section">
        <button class="btn-logout" onclick="cerrarSesion()">
          <i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span>
        </button>
      </div>
    </aside>

    <!-- CONTENIDO -->
    <div class="main-content">
      <!-- Header -->
      <header class="page-header">
        <div class="header-left">
          <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
          <div>
            <h1><i class="fas fa-percent"></i> Módulo de Impuestos</h1>
            <div class="breadcrumb">
              <a href="/dashboard"><i class="fas fa-home"></i> Inicio</a>
              <span>/</span><span>Impuestos</span>
            </div>
          </div>
        </div>
        <div class="header-right">
          <button class="btn btn-primary" onclick="abrirModalImpuesto()">
            <i class="fas fa-plus"></i> Nuevo Impuesto
          </button>
        </div>
      </header>

      <!-- (Opcional) Tabs-container como en Compras; aquí no usamos pestañas, solo contenido -->
      <div class="tabs-container">
        <div class="tabs-nav">
          <button class="tab-button active" data-tab="impuestos">
            <i class="fas fa-percent"></i><span>Impuestos</span>
            <span class="tab-badge" id="badgeImpuestos" th:text="${#lists.size(impuestos)}">0</span>
          </button>
        </div>
      </div>

      <!-- Sección principal -->
      <section class="content-section">
        <!-- Tarjetas de stats -->
        <div class="stats-grid">
          <div class="stat-card" style="border-left-color: var(--azul-principal)">
            <div class="stat-header">
              <div class="stat-icon" style="background: linear-gradient(135deg, var(--azul-principal), var(--azul-secundario));">
                <i class="fas fa-percent"></i>
              </div>
            </div>
            <div class="stat-value" id="totalImpuestos" th:text="${#lists.size(impuestos)}">0</div>
            <div class="stat-label">Total de Impuestos</div>
          </div>

          <div class="stat-card" style="border-left-color: var(--verde-exito)">
            <div class="stat-header">
              <div class="stat-icon" style="background: linear-gradient(135deg, var(--verde-exito), var(--verde-exito-gradient));">
                <i class="fas fa-toggle-on"></i>
              </div>
            </div>
            <div class="stat-value" id="impuestosActivos">0</div>
            <div class="stat-label">Impuestos Activos</div>
          </div>

          <div class="stat-card" style="border-left-color: var(--rojo-peligro)">
            <div class="stat-header">
              <div class="stat-icon" style="background: linear-gradient(135deg, var(--rojo-peligro), var(--rojo-peligro-dark));">
                <i class="fas fa-toggle-off"></i>
              </div>
            </div>
            <div class="stat-value" id="impuestosInactivos">0</div>
            <div class="stat-label">Impuestos Inactivos</div>
          </div>

          <div class="stat-card" style="border-left-color: var(--morado)">
            <div class="stat-header">
              <div class="stat-icon" style="background: linear-gradient(135deg, var(--morado), var(--morado-dark));">
                <i class="fas fa-percentage"></i>
              </div>
            </div>
            <div class="stat-value" id="tasaPromedio">0%</div>
            <div class="stat-label">Tasa Promedio</div>
          </div>
        </div>

        <!-- Toolbar con buscador y filtros -->
        <div class="toolbar">
          <div class="search-box">
            <i class="fas fa-search input-icon"></i>
            <input type="text" class="search-input" id="searchImpuestos" placeholder="Buscar por nombre o tipo…">
          </div>
          <div class="toolbar-actions">
            <select class="filter-select" id="tipoFilter">
              <option value="">Todos los tipos</option>
              <option value="IVA">IVA</option>
              <option value="ISR">ISR</option>
              <option value="IEPS">IEPS</option>
              <option value="OTRO">OTRO</option>
            </select>
            <select class="filter-select" id="estadoFilter">
              <option value="">Todos los estados</option>
              <option value="ACTIVO">Activo</option>
              <option value="INACTIVO">Inactivo</option>
            </select>
            <button class="btn btn-secondary" onclick="refrescarContadores()">
              <i class="fas fa-sync-alt"></i> Actualizar
            </button>
          </div>
        </div>

        <!-- Tabla -->
        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title"><i class="fas fa-list"></i> Listado de Impuestos</h3>
          </div>

         <table class="table" id="tablaImpuestos">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Tipo</th>
      <th>Tasa</th>
      <th>Descripción</th>
      <th>Estado</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    <tr th:if="${impuestos == null or #lists.isEmpty(impuestos)}">
      <td colspan="7" class="empty-state">
        <i class="fas fa-percent"></i>
        <h3>No hay impuestos registrados</h3>
        <p>Comienza creando tu primer impuesto</p>
      </td>
    </tr>

    <tr th:each="i : ${impuestos}" data-row="impuesto">
      <td th:text="${i.id_impuesto}">1</td>
      <td th:text="${i.nombre}">IVA</td>
      <td th:text="${i.tipo}">IVA</td>
      <td>
        <span th:text="${#numbers.formatDecimal(i.tasa, 1, 'COMMA', 2, 'POINT')}">16.00</span><span>%</span>
      </td>
      <td th:text="${i.descripcion}">Impuesto al Valor Agregado</td>
      <td>
        <span th:classappend="${i.estado=='ACTIVO'} ? 'badge badge-success' : 'badge badge-danger'"
              th:text="${i.estado}">ACTIVO</span>
      </td>
      <td>
        <a th:href="@{'/impuesto/editar/' + ${i.id_impuesto}}" class="btn btn-icon btn-warning" title="Editar">
          <i class="fas fa-edit"></i>
        </a>
        <a th:href="@{'/impuesto/eliminar/' + ${i.id_impuesto}}" class="btn btn-icon btn-danger" title="Eliminar"
           onclick="return confirm('¿Eliminar impuesto?');">
          <i class="fas fa-trash"></i>
        </a>
      </td>
    </tr>
  </tbody>
</table>

        </div>
      </section>
    </div>
  </div>

  <!-- Modal: Nuevo/Editar Impuesto -->
  <div class="modal" id="modalImpuesto">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modalImpuestoTitle">
          <i class="fas fa-plus-circle"></i> Nuevo Impuesto
        </h3>
        <button class="modal-close" onclick="cerrarModal('modalImpuesto')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form th:action="@{/impuesto/guardar}" method="post" id="formImpuesto">
          <input type="hidden" name="id_impuesto" th:value="${impuesto?.id_impuesto}">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label"><i class="fas fa-file-signature"></i> Nombre <span class="required">*</span></label>
              <input type="text" class="form-input" name="nombre" required th:value="${impuesto?.nombre}">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-tags"></i> Tipo <span class="required">*</span></label>
              <select class="form-select" name="tipo" required th:value="${impuesto?.tipo}">
                <option value="IVA">IVA</option>
                <option value="ISR">ISR</option>
                <option value="IEPS">IEPS</option>
                <option value="OTRO">OTRO</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-percentage"></i> Tasa (%) <span class="required">*</span></label>
              <input type="number" class="form-input" name="tasa" step="0.01" min="0" required th:value="${impuesto?.tasa}">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-toggle-on"></i> Estado</label>
              <select class="form-select" name="estado" th:value="${impuesto?.estado}">
                <option value="ACTIVO">ACTIVO</option>
                <option value="INACTIVO">INACTIVO</option>
              </select>
            </div>

            <div class="form-group full-width">
              <label class="form-label"><i class="fas fa-comment"></i> Descripción</label>
              <textarea class="form-textarea" name="descripcion" th:text="${impuesto?.descripcion}"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalImpuesto')">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="submit" class="btn btn-primary" form="formImpuesto">
          <i class="fas fa-save"></i> Guardar
        </button>
      </div>
    </div>
  </div>

  <script>
    // Toggle sidebar (móvil)
    function toggleSidebar() {
      const s = document.getElementById('sidebar');
      s.style.display = (s.style.display === 'none') ? '' : 'none';
    }
    function cerrarSesion(){ /* integra tu lógica */ }

    // Modal helpers
    function abrirModalImpuesto() {
      document.getElementById('modalImpuestoTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Nuevo Impuesto';
      document.getElementById('formImpuesto').reset();
      document.getElementById('modalImpuesto').classList.add('active');
    }
    function cerrarModal(id){ document.getElementById(id).classList.remove('active'); }

    // Filtros/busqueda en tabla
    const search = document.getElementById('searchImpuestos');
    const tipoF = document.getElementById('tipoFilter');
    const estadoF = document.getElementById('estadoFilter');
    [search, tipoF, estadoF].forEach(el => el && el.addEventListener('input', filtrarTabla));

    function filtrarTabla(){
      const term = (search?.value || '').toLowerCase();
      const tipo = tipoF?.value || '';
      const estado = estadoF?.value || '';
      const rows = document.querySelectorAll('#tablaImpuestos tbody tr[data-row="impuesto"]');
      let activos = 0, inactivos = 0, tasas = [], visibles = 0;

      rows.forEach(r=>{
        const nombre = r.children[1].textContent.toLowerCase();
        const t = r.children[2].textContent.trim();
        const tasa = parseFloat(r.children[3].textContent.replace(',', '.')) || 0;
        const est = r.children[4].textContent.trim();

        const okBusca = !term || nombre.includes(term) || t.toLowerCase().includes(term);
        const okTipo = !tipo || t === tipo;
        const okEstado = !estado || est === estado;

        const show = okBusca && okTipo && okEstado;
        r.style.display = show ? '' : 'none';

        if(show){
          visibles++;
          tasas.push(tasa);
          if(est === 'ACTIVO') activos++; else inactivos++;
        }
      });

      document.getElementById('badgeImpuestos').textContent = visibles;
      document.getElementById('totalImpuestos').textContent = visibles;
      document.getElementById('impuestosActivos').textContent = activos;
      document.getElementById('impuestosInactivos').textContent = inactivos;
      const avg = tasas.length ? (tasas.reduce((a,b)=>a+b,0)/tasas.length) : 0;
      document.getElementById('tasaPromedio').textContent = (Math.round(avg*100)/100).toFixed(2) + '%';
    }

    function refrescarContadores(){ filtrarTabla(); }

    // Inicial: calcula contadores al cargar
    document.addEventListener('DOMContentLoaded', filtrarTabla);
  </script>
</body>
</html>
