<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ERP - Contabilidad</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f8fafc;          
      --panel:#e0f2fe;       
      --muted:#bae6fd;       
      --line:#93c5fd;        
      --text:#0f172a;        
      --text-dim:#475569;    
      --primary:#3b82f6;     
      --primary-600:#2563eb; 
      --danger:#ef4444;      
      --warning:#f59e0b;     
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    aside{background:var(--panel);border-right:1px solid var(--line);padding:20px;position:sticky;top:0;height:100vh}
    .logo{font-weight:800;letter-spacing:.5px;margin-bottom:16px}
    .tag{display:inline-block;font-size:12px;color:#1e3a8a;background:#bfdbfe;padding:2px 8px;border-radius:999px}
    nav button{width:100%;text-align:left;background:transparent;border:1px solid var(--line);color:var(--text);padding:10px 12px;margin:6px 0;border-radius:12px;cursor:pointer}
    nav button.active{background:linear-gradient(180deg,#dbeafe,#bfdbfe);border-color:#2563eb;color:#1e3a8a;box-shadow:0 0 0 2px rgba(59,130,246,.15) inset}
    header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--line);background:rgba(219,234,254,.7);backdrop-filter:saturate(120%) blur(6px);position:sticky;top:0;z-index:10}
    .pill{font-size:12px;color:var(--text-dim)}
    .container{padding:20px;max-width:1400px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .card{background:#ffffff;border:1px solid var(--line);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.08);overflow:hidden}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px;color:#1e3a8a;background:#f1f5f9}
    .card .body{padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:6px}
    input,select,textarea{width:100%;background:#f9fafb;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:12px}
    input[type="date"]{padding:8px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
    th{color:#1e3a8a;background:#e0f2fe}
    tr:hover td{background:#f0f9ff}
    .right{text-align:right}
    .center{text-align:center}
    .btn{background:var(--primary);border:none;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#e0f2fe;color:#0f172a;border:1px solid var(--line)}
    .btn.warn{background:var(--warning);color:#190b00}
    .btn.danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:var(--text-dim)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px;color:#1e3a8a;background:#e0f2fe}
    .totals{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}
    .totals .kpi{background:#f9fafb;border:1px solid var(--line);padding:8px 12px;border-radius:10px}
    .toast{position:fixed;bottom:20px;right:20px;background:#ffffff;border:1px solid var(--line);padding:12px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.2);display:none}
    .footer-note{font-size:12px;color:var(--text-dim)}
    .danger-text{color:#dc2626}
    .ok-text{color:#16a34a}
    .scroll{max-height:420px;overflow:auto}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <div class="layout">
    <aside>
      <div class="logo">ERP <span class="tag">Contabilidad</span></div>
      <hr style="border:0;border-top:1px solid var(--line);margin:12px 0 8px">
      <nav id="nav"></nav>
      <div style="position:absolute;bottom:12px;left:20px;right:20px;color:var(--text-dim);font-size:12px">
      </div>
    </aside>

    <main>
      <header>
        <div>
          <div style="font-weight:700">Contabilidad</div>
        </div>
        <div class="toolbar">
          <button class="btn secondary" id="btnBackup">Inicio</button>
          <input type="file" id="fileRestore" accept="application/json" style="display:none" />
          <button class="btn" id="btnRestore">Restaurar</button>
          <button class="btn danger" id="btnReset">Reiniciar Datos</button>
        </div>
      </header>

      <div class="container">
        
        <section id="view"></section>
      </div>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <template id="tpl-plan">
    <div class="grid cols-2">
      <div class="card">
        <h3>Plan de Cuentas</h3>
        <div class="body">
          <div class="row">
            <div>
              <label>Código (único)</label>
              <input id="accCode" placeholder="100-01" />
            </div>
            <div>
              <label>Nombre</label>
              <input id="accName" placeholder="Caja General" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Tipo</label>
              <select id="accType">
                <option value="Activo">Activo</option>
                <option value="Pasivo">Pasivo</option>
                <option value="Capital">Capital</option>
                <option value="Ingresos">Ingresos</option>
                <option value="Gastos">Gastos</option>
              </select>
            </div>
            <div>
              <label>Naturaleza</label>
              <select id="accNature">
                <option value="Deudora">Deudora</option>
                <option value="Acreedora">Acreedora</option>
              </select>
            </div>
          </div>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn" id="btnAddAcc">Agregar</button>
            <button class="btn secondary" id="btnSeed">Cargar Plan Básico</button>
            
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Listado de Cuentas</h3>
        <div class="body">
          <div class="row">
            <div>
              <label>Buscar</label>
              <input id="accSearch" placeholder="Código o nombre" />
            </div>
          </div>
          <div class="scroll">
            <table id="tblAccounts">
              <thead>
                <tr><th>Código</th><th>Nombre</th><th>Tipo</th><th>Naturaleza</th><th class="center">Acciones</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
    </div>
  </template>

  <template id="tpl-polizas">
    <div class="grid cols-2">
      <div class="card">
        <h3>Nueva Póliza (Asiento)</h3>
        <div class="body">
          <div class="row">
            <div>
              <label>Folio</label>
              <input id="polFolio" disabled />
            </div>
            <div>
              <label>Fecha</label>
              <input type="date" id="polDate" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Descripción</label>
              <input id="polDesc" placeholder="Pago de renta, factura 123" />
            </div>
          </div>

          <table id="tblLines">
            <thead>
              <tr><th style="width:38%">Cuenta</th><th>Descripción</th><th class="right">Debe</th><th class="right">Haber</th><th class="center">#</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="totals">
            <div class="kpi">Debe: <strong id="sumDebe">$0.00</strong></div>
            <div class="kpi">Haber: <strong id="sumHaber">$0.00</strong></div>
            <div class="kpi">Diferencia: <strong id="sumDiff">$0.00</strong></div>
          </div>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn secondary" id="btnAddLine">Añadir línea</button>
            <button class="btn" id="btnSavePol">Guardar y Postear</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Pólizas Guardadas</h3>
        <div class="body">
          <div class="row">
            <div>
              <label>Rango de fechas</label>
              <div class="row">
                <input type="date" id="fltFrom" />
                <input type="date" id="fltTo" />
              </div>
            </div>
            <div style="align-self:flex-end">
              <button class="btn secondary" id="btnFilterPols">Filtrar</button>
              <button class="btn" id="btnExportPols">Exportar CSV</button>
            </div>
          </div>
          <div class="scroll">
            <table id="tblPols">
              <thead>
                <tr><th>Folio</th><th>Fecha</th><th>Descripción</th><th class="right">Debe</th><th class="right">Haber</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-mayor">
    <div class="card">
      <h3>Libro Mayor</h3>
      <div class="body">
        <div class="row">
          <div>
            <label>Cuenta</label>
            <select id="mayorAcc"></select>
          </div>
          <div>
            <label>Desde</label>
            <input type="date" id="mayorFrom" />
          </div>
          <div>
            <label>Hasta</label>
            <input type="date" id="mayorTo" />
          </div>
          <div style="align-self:flex-end">
            <button class="btn secondary" id="btnMayor">Ver</button>
            <button class="btn" id="btnExportMayor">Exportar CSV</button>
          </div>
        </div>
        <div class="scroll">
          <table id="tblMayor">
            <thead>
              <tr><th>Fecha</th><th>Folio</th><th>Descripción</th><th class="right">Debe</th><th class="right">Haber</th><th class="right">Saldo</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-balanza">
    <div class="card">
      <h3>Balanza de Comprobación</h3>
      <div class="body">
        <div class="row">
          <div>
            <label>Desde</label>
            <input type="date" id="balFrom" />
          </div>
          <div>
            <label>Hasta</label>
            <input type="date" id="balTo" />
          </div>
          <div style="align-self:flex-end">
            <button class="btn secondary" id="btnBalanza">Calcular</button>
            <button class="btn" id="btnExportBalanza">Exportar CSV</button>
          </div>
        </div>
        <div class="scroll">
          <table id="tblBalanza">
            <thead>
              <tr><th>Código</th><th>Cuenta</th><th class="right">Debe</th><th class="right">Haber</th><th class="right">Saldo</th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr><th colspan="2" class="right">Totales</th><th class="right" id="balDebe">$0.00</th><th class="right" id="balHaber">$0.00</th><th class="right" id="balSaldo">$0.00</th></tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-estados">
    <div class="grid cols-2">
      <div class="card">
        <h3>Estado de Resultados</h3>
        <div class="body">
          <div class="row">
            <input type="date" id="erFrom" />
            <input type="date" id="erTo" />
            <button class="btn" id="btnER">Calcular</button>
          </div>
          <div class="scroll">
            <table id="tblER">
              <thead>
                <tr><th>Concepto</th><th class="right">Importe</th></tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr><th>Utilidad (pérdida) del periodo</th><th class="right" id="erUtilidad">$0.00</th></tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Balance General</h3>
        <div class="body">
          <div class="row">
            <input type="date" id="bgAsOf" />
            <button class="btn" id="btnBG">Calcular</button>
          </div>
          <div class="grid cols-3">
            <div>
              <div class="badge">Activos</div>
              <table id="bgActivos"><tbody></tbody><tfoot><tr><th>Total Activos</th><th class="right" id="bgTotAct">$0.00</th></tr></tfoot></table>
            </div>
            <div>
              <div class="badge">Pasivos</div>
              <table id="bgPasivos"><tbody></tbody><tfoot><tr><th>Total Pasivos</th><th class="right" id="bgTotPas">$0.00</th></tr></tfoot></table>
            </div>
            <div>
              <div class="badge">Capital</div>
              <table id="bgCapital"><tbody></tbody><tfoot><tr><th>Total Capital</th><th class="right" id="bgTotCap">$0.00</th></tr></tfoot></table>
            </div>
          </div>
          <div class="totals">
            <div class="kpi">Activos = <strong id="kpiAct">$0.00</strong></div>
            <div class="kpi">Pasivo + Capital = <strong id="kpiPyC">$0.00</strong></div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
   
    const fmt = new Intl.NumberFormat('es-MX',{ style:'currency', currency:'MXN' });
    const $ = (sel,ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));
    const todayStr = ()=> new Date().toISOString().slice(0,10);

    const store={
      get k(){return {
        accounts:'erp_accounts_v1',
        entries:'erp_entries_v1',
        folio:'erp_folio_v1'
      }},
      read(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def }catch(e){ return def } },
      write(key, val){ localStorage.setItem(key, JSON.stringify(val)); },
      backup(){ return JSON.stringify({
        accounts: store.read(store.k.accounts,[]),
        entries: store.read(store.k.entries,[]),
        folio: store.read(store.k.folio,1)
      }, null, 2); },
      restore(json){ const data = JSON.parse(json); if(!data.accounts||!data.entries) throw new Error('Archivo no válido');
        store.write(store.k.accounts, data.accounts); store.write(store.k.entries, data.entries); store.write(store.k.folio, data.folio||1);
      },
      reset(){ localStorage.removeItem(store.k.accounts); localStorage.removeItem(store.k.entries); localStorage.removeItem(store.k.folio); }
    };

    function toast(msg, type='info'){ const el=$('#toast'); el.textContent=msg; el.style.display='block'; el.style.borderColor= type==='error'? 'var(--danger)': type==='warn'? 'var(--warning)': 'var(--line)'; setTimeout(()=>el.style.display='none', 2500); }

    function uniqBy(arr, key){ const m=new Map(); arr.forEach(it=>m.set(key(it), it)); return [...m.values()] }

    
    function seedPlanBasico(){
      const base=[
        {code:'100', name:'Activos', type:'Activo', nature:'Deudora'},
        {code:'110', name:'Efectivo y equivalentes', type:'Activo', nature:'Deudora'},
        {code:'110-01', name:'Caja General', type:'Activo', nature:'Deudora'},
        {code:'110-02', name:'Bancos', type:'Activo', nature:'Deudora'},
        {code:'120', name:'Clientes', type:'Activo', nature:'Deudora'},
        {code:'130', name:'Inventarios', type:'Activo', nature:'Deudora'},
        {code:'200', name:'Pasivos', type:'Pasivo', nature:'Acreedora'},
        {code:'210', name:'Proveedores', type:'Pasivo', nature:'Acreedora'},
        {code:'220', name:'Acreedores diversos', type:'Pasivo', nature:'Acreedora'},
        {code:'300', name:'Capital', type:'Capital', nature:'Acreedora'},
        {code:'310', name:'Capital social', type:'Capital', nature:'Acreedora'},
        {code:'320', name:'Resultados acumulados', type:'Capital', nature:'Acreedora'},
        {code:'400', name:'Ingresos', type:'Ingresos', nature:'Acreedora'},
        {code:'410', name:'Ventas', type:'Ingresos', nature:'Acreedora'},
        {code:'420', name:'Ingresos financieros', type:'Ingresos', nature:'Acreedora'},
        {code:'500', name:'Gastos', type:'Gastos', nature:'Deudora'},
        {code:'510', name:'Gastos de operación', type:'Gastos', nature:'Deudora'},
        {code:'510-01', name:'Renta', type:'Gastos', nature:'Deudora'},
        {code:'510-02', name:'Sueldos', type:'Gastos', nature:'Deudora'},
      ];
      const current = store.read(store.k.accounts,[]);
      const merged = uniqBy([...current, ...base], x=>x.code);
      store.write(store.k.accounts, merged);
    }

    
    const routes=[
      {id:'plan', name:'Plan de Cuentas', tpl:'#tpl-plan'},
      {id:'polizas', name:'Pólizas', tpl:'#tpl-polizas'},
      {id:'mayor', name:'Libro Mayor', tpl:'#tpl-mayor'},
      {id:'balanza', name:'Balanza de Comprobación', tpl:'#tpl-balanza'},
      {id:'estados', name:'Estados Financieros', tpl:'#tpl-estados'},
    ];

    function renderNav(){ const nav=$('#nav'); nav.innerHTML=''; routes.forEach(r=>{
      const b=document.createElement('button'); b.textContent=r.name; b.onclick=()=>go(r.id);
      b.id='nav-'+r.id; nav.appendChild(b);
    })}

    function go(id){ const route=routes.find(r=>r.id===id); if(!route) return; $('#view').innerHTML='';
      $('#view').appendChild($(route.tpl).content.cloneNode(true));
      $$('#nav button').forEach(b=>b.classList.toggle('active', b.id==='nav-'+id));
      
      if(id==='plan') initPlan();
      if(id==='polizas') initPolizas();
      if(id==='mayor') initMayor();
      if(id==='balanza') initBalanza();
      if(id==='estados') initEstados();
    }

    
    function initPlan(){
      $('#btnSeed').onclick=()=>{ seedPlanBasico(); fillAccounts(); toast('Plan básico cargado') };
      $('#btnAddAcc').onclick=addAccount;
      $('#accSearch').oninput=fillAccounts;
      fillAccounts();
    }

    function addAccount(){
      const code=$('#accCode').value.trim();
      const name=$('#accName').value.trim();
      const type=$('#accType').value; const nature=$('#accNature').value;
      if(!code||!name) return toast('Código y nombre son obligatorios','error');
      const accs=store.read(store.k.accounts,[]);
      if(accs.some(a=>a.code===code)) return toast('El código ya existe','error');
      accs.push({code,name,type,nature});
      accs.sort((a,b)=>a.code.localeCompare(b.code));
      store.write(store.k.accounts, accs);
      fillAccounts();
      $('#accCode').value=''; $('#accName').value='';
      toast('Cuenta agregada');
    }

    function fillAccounts(){
      const q=($('#accSearch')?.value||'').toLowerCase();
      const accs=store.read(store.k.accounts,[]).filter(a=> a.code.toLowerCase().includes(q) || a.name.toLowerCase().includes(q));
      const tbody=$('#tblAccounts tbody'); tbody.innerHTML='';
      accs.forEach(a=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="nowrap" data-k="code">${a.code}</td>
                      <td contenteditable data-k="name">${a.name}</td>
                      <td>
                        <select data-k="type">
                          ${['Activo','Pasivo','Capital','Ingresos','Gastos'].map(t=>`<option ${a.type===t?'selected':''}>${t}</option>`).join('')}
                        </select>
                      </td>
                      <td>
                        <select data-k="nature">
                          ${['Deudora','Acreedora'].map(t=>`<option ${a.nature===t?'selected':''}>${t}</option>`).join('')}
                        </select>
                      </td>
                      <td class="center">
                        <button class="btn secondary" data-act="save">Guardar</button>
                        <button class="btn danger" data-act="del">Borrar</button>
                      </td>`;
        tr.querySelector('[data-act="save"]').onclick=()=>{ saveRow(tr) };
        tr.querySelector('[data-act="del"]').onclick=()=>{ delAccount(a.code) };
        tbody.appendChild(tr);
      })
    }

    function saveRow(tr){
      const code=tr.querySelector('[data-k="code"]').textContent.trim();
      const name=tr.querySelector('[data-k="name"]').textContent.trim();
      const type=tr.querySelector('[data-k="type"]').value; const nature=tr.querySelector('[data-k="nature"]').value;
      const accs=store.read(store.k.accounts,[]);
      const idx=accs.findIndex(a=>a.code===code); if(idx<0) return;
      accs[idx]={code,name,type,nature}; store.write(store.k.accounts,accs); toast('Cuenta actualizada');
    }

    function delAccount(code){
      
      const entries=store.read(store.k.entries,[]);
      const hasMov=entries.some(p=> p.lines.some(l=>l.acc===code));
      if(hasMov) return toast('No se puede borrar: tiene movimientos','error');
      let accs=store.read(store.k.accounts,[]); accs=accs.filter(a=>a.code!==code); store.write(store.k.accounts,accs); fillAccounts(); toast('Cuenta borrada');
    }

    
    function initPolizas(){
      const folio=store.read(store.k.folio,1); $('#polFolio').value=String(folio).padStart(6,'0');
      $('#polDate').value=todayStr();
      $('#btnAddLine').onclick=addLine; $('#btnSavePol').onclick=savePoliza;
      $('#btnFilterPols').onclick=renderPols; $('#btnExportPols').onclick=()=>exportTableCSV('#tblPols','polizas.csv');
      addLine(); addLine();
      renderPols();
    }

    function accountOptions(){
      const accs=store.read(store.k.accounts,[]);
      return accs.map(a=>`<option value="${a.code}">${a.code} — ${a.name}</option>`).join('');
    }

    function addLine(){
      const tbody=$('#tblLines tbody');
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><select class="accSel">${accountOptions()}</select></td>
                    <td><input placeholder="Detalle" class="lnDesc"/></td>
                    <td class="right"><input inputmode="decimal" class="lnDebe" placeholder="0.00" /></td>
                    <td class="right"><input inputmode="decimal" class="lnHaber" placeholder="0.00" /></td>
                    <td class="center"><button class="btn danger">×</button></td>`;
      tr.querySelector('.btn.danger').onclick=()=>{ tr.remove(); recalcLines() };
      ['.lnDebe','.lnHaber'].forEach(sel=> tr.querySelector(sel).addEventListener('input', recalcLines));
      tbody.appendChild(tr); recalcLines();
    }

    function num(v){ v=String(v||'').replace(/[, ]/g,''); const n=parseFloat(v); return isNaN(n)?0:n }

    function recalcLines(){
      let deb=0, hab=0; $$('#tblLines tbody tr').forEach(tr=>{ deb+=num($('.lnDebe',tr).value); hab+=num($('.lnHaber',tr).value) });
      $('#sumDebe').textContent=fmt.format(deb); $('#sumHaber').textContent=fmt.format(hab); $('#sumDiff').textContent=fmt.format(Math.abs(deb-hab));
      $('#sumDiff').parentElement.className = 'kpi ' + (deb===hab? 'ok-text':'danger-text');
    }

    function savePoliza(){
      const date=$('#polDate').value; const desc=$('#polDesc').value.trim();
      const folio=parseInt($('#polFolio').value,10);
      const lines=$$('#tblLines tbody tr').map(tr=>({
        acc: $('.accSel',tr).value,
        desc: $('.lnDesc',tr).value.trim(),
        debe: num($('.lnDebe',tr).value),
        haber: num($('.lnHaber',tr).value)
      })).filter(l=>l.debe>0 || l.haber>0);
      if(!date||!desc||lines.length<2) return toast('Fecha, descripción y al menos 2 líneas','error');
      const sumDebe=lines.reduce((s,l)=>s+l.debe,0).toFixed(2);
      const sumHaber=lines.reduce((s,l)=>s+l.haber,0).toFixed(2);
      if(sumDebe!==sumHaber) return toast('El asiento no cuadra (Debe ≠ Haber)','error');
      const pol={ folio, date, desc, lines };
      const arr=store.read(store.k.entries,[]); arr.push(pol); store.write(store.k.entries, arr);
      store.write(store.k.folio, folio+1);
      toast('Póliza guardada y posteada');
      go('polizas');
    }

    function renderPols(){
      const from=$('#fltFrom').value; const to=$('#fltTo').value; const tbody=$('#tblPols tbody'); tbody.innerHTML='';
      const arr=store.read(store.k.entries,[]).filter(p=> within(p.date, from, to));
      arr.sort((a,b)=> a.date.localeCompare(b.date) || a.folio-b.folio);
      arr.forEach(p=>{
        const deb=p.lines.reduce((s,l)=>s+l.debe,0); const hab=p.lines.reduce((s,l)=>s+l.haber,0);
        const tr=document.createElement('tr'); tr.innerHTML=`<td class="nowrap">${String(p.folio).padStart(6,'0')}</td><td>${p.date}</td><td>${p.desc}</td><td class="right">${fmt.format(deb)}</td><td class="right">${fmt.format(hab)}</td>`;
        tbody.appendChild(tr);
      })
    }

    function within(date, from, to){ if(from && date<from) return false; if(to && date>to) return false; return true }

    
    function initMayor(){ fillAccSelect($('#mayorAcc')); $('#mayorFrom').value=''; $('#mayorTo').value=''; $('#btnMayor').onclick=renderMayor; $('#btnExportMayor').onclick=()=>exportTableCSV('#tblMayor','mayor.csv'); }
    function fillAccSelect(sel){ sel.innerHTML= store.read(store.k.accounts,[]).map(a=>`<option value="${a.code}">${a.code} — ${a.name}</option>`).join(''); }

    function renderMayor(){ const acc=$('#mayorAcc').value; const from=$('#mayorFrom').value; const to=$('#mayorTo').value; const tbody=$('#tblMayor tbody'); tbody.innerHTML='';
      let saldo=0; const entries=store.read(store.k.entries,[]).filter(p=>within(p.date,from,to));
      
      entries.sort((a,b)=> a.date.localeCompare(b.date) || a.folio-b.folio);
      const accInfo = store.read(store.k.accounts,[]).find(a=>a.code===acc) || {nature:'Deudora'};
      entries.forEach(p=>{
        p.lines.filter(l=>l.acc===acc).forEach(l=>{
          const debe=l.debe, haber=l.haber;
          
          saldo += (accInfo.nature==='Deudora'? (debe-haber) : (haber-debe));
          const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.date}</td><td class="nowrap">${String(p.folio).padStart(6,'0')}</td><td>${p.desc}${l.desc? ' — '+l.desc:''}</td><td class="right">${debe?fmt.format(debe):''}</td><td class="right">${haber?fmt.format(haber):''}</td><td class="right">${fmt.format(saldo)}</td>`;
          tbody.appendChild(tr);
        })
      })
    }

    
    function initBalanza(){ $('#btnBalanza').onclick=renderBalanza; $('#btnExportBalanza').onclick=()=>exportTableCSV('#tblBalanza','balanza.csv'); }

    function renderBalanza(){ const from=$('#balFrom').value; const to=$('#balTo').value; const tbody=$('#tblBalanza tbody'); tbody.innerHTML=''; let tDebe=0,tHaber=0,tSaldo=0;
      const accs=store.read(store.k.accounts,[]);
      const entries=store.read(store.k.entries,[]).filter(p=>within(p.date,from,to));
      accs.forEach(a=>{
        let debe=0, haber=0; entries.forEach(p=> p.lines.filter(l=>l.acc===a.code).forEach(l=>{ debe+=l.debe; haber+=l.haber; }));
        const saldo = a.nature==='Deudora' ? (debe-haber) : (haber-debe);
        if(debe!==0 || haber!==0 || saldo!==0){
          const tr=document.createElement('tr'); tr.innerHTML=`<td class="nowrap">${a.code}</td><td>${a.name}</td><td class="right">${fmt.format(debe)}</td><td class="right">${fmt.format(haber)}</td><td class="right">${fmt.format(saldo)}</td>`; tbody.appendChild(tr);
        }
        tDebe+=debe; tHaber+=haber; tSaldo+=saldo;
      })
      $('#balDebe').textContent=fmt.format(tDebe); $('#balHaber').textContent=fmt.format(tHaber); $('#balSaldo').textContent=fmt.format(tSaldo);
    }

    
    function initEstados(){ $('#erFrom').value=''; $('#erTo').value=''; $('#bgAsOf').value=todayStr(); $('#btnER').onclick=renderER; $('#btnBG').onclick=renderBG; }

    function sumByType(type, from, to){
      const accs=store.read(store.k.accounts,[]).filter(a=>a.type===type);
      const entries=store.read(store.k.entries,[]).filter(p=>within(p.date,from,to));
      let map=new Map(); accs.forEach(a=>map.set(a.code,0));
      entries.forEach(p=> p.lines.forEach(l=>{
        const a=accs.find(x=>x.code===l.acc); if(!a) return;
        const delta = a.nature==='Deudora' ? (l.debe - l.haber) : (l.haber - l.debe);
        map.set(a.code, (map.get(a.code)||0) + delta);
      }));
      return {total: [...map.values()].reduce((s,v)=>s+v,0), detail:[...map.entries()].map(([code,importe])=>({code,importe, name: (store.read(store.k.accounts,[]).find(a=>a.code===code)||{}).name })) };
    }

    function renderER(){ const from=$('#erFrom').value; const to=$('#erTo').value; const tbody=$('#tblER tbody'); tbody.innerHTML='';
      const ingresos=sumByType('Ingresos',from,to); const gastos=sumByType('Gastos',from,to);
      function row(name, amt){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${name}</td><td class="right">${fmt.format(amt)}</td>`; return tr }
      tbody.appendChild(row('Ingresos', ingresos.total));
      ingresos.detail.filter(d=>d.importe!==0).forEach(d=> tbody.appendChild(row('— '+d.name, d.importe)) );
      tbody.appendChild(row('Gastos', -gastos.total));
      gastos.detail.filter(d=>d.importe!==0).forEach(d=> tbody.appendChild(row('— '+d.name, -d.importe)) );
      const utilidad = ingresos.total + gastos.total; 
      $('#erUtilidad').textContent=fmt.format(utilidad);
    }

    function renderBG(){ const asOf=$('#bgAsOf').value; const tbA=$('#bgActivos tbody'); const tbP=$('#bgPasivos tbody'); const tbC=$('#bgCapital tbody'); tbA.innerHTML=''; tbP.innerHTML=''; tbC.innerHTML='';
      const accs=store.read(store.k.accounts,[]);
      const entries=store.read(store.k.entries,[]).filter(p=>!asOf || p.date<=asOf);
      function saldoCuenta(a){ let debe=0,haber=0; entries.forEach(p=> p.lines.filter(l=>l.acc===a.code).forEach(l=>{ debe+=l.debe; haber+=l.haber; })); return a.nature==='Deudora'?(debe-haber):(haber-debe) }
      let totA=0,totP=0,totC=0;
      accs.forEach(a=>{
        const s=saldoCuenta(a); if(Math.abs(s)<0.005) return;
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.code} — ${a.name}</td><td class="right">${fmt.format(s)}</td>`;
        if(a.type==='Activo'){tbA.appendChild(tr); totA+=s}
        else if(a.type==='Pasivo'){tbP.appendChild(tr); totP+=s}
        else if(a.type==='Capital'){tbC.appendChild(tr); totC+=s}
      })
      $('#bgTotAct').textContent=fmt.format(totA); $('#bgTotPas').textContent=fmt.format(totP); $('#bgTotCap').textContent=fmt.format(totC);
      $('#kpiAct').textContent=fmt.format(totA); $('#kpiPyC').textContent=fmt.format(totP+totC);
    }

    
    function exportTableCSV(sel, filename){
      const rows=[...$$(sel+' tr')].map(tr=> [...tr.children].map(td=> '"'+td.textContent.replace(/"/g,'\"').trim()+'"').join(','));
      const csv=rows.join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
    }

   
    $('#btnBackup').onclick=()=>{ const blob=new Blob([store.backup()],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='erp_contabilidad_backup.json'; a.click(); URL.revokeObjectURL(a.href); }
    $('#btnRestore').onclick=()=> $('#fileRestore').click();
    $('#fileRestore').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const txt=await f.text(); try{ store.restore(txt); toast('Datos restaurados'); go(currentRoute||'plan'); }catch(err){ toast('Error al restaurar: '+err.message,'error') } });
    $('#btnReset').onclick=()=>{ if(confirm('Esto borrará todas las cuentas y pólizas. ¿Continuar?')){ store.reset(); toast('Datos reiniciados'); go('plan'); } };

  
    renderNav();
    let currentRoute='plan';
    go('plan');
    if((store.read(store.k.accounts,[]).length||0)===0){ seedPlanBasico(); toast('Plan básico cargado'); }
  </script>
</body>
</html>
